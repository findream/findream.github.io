<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="HaCky的安全备忘录" type="application/atom+xml" />






<meta name="description" content="本文转载于跳跳糖安全社区，原文链接为https://tttang.com/archive/1640/">
<meta property="og:type" content="article">
<meta property="og:title" content="WMI调试与检测">
<meta property="og:url" content="https://findream.github.io/2021/11/06/WMI调试与检测/index.html">
<meta property="og:site_name" content="HaCky的安全备忘录">
<meta property="og:description" content="本文转载于跳跳糖安全社区，原文链接为https://tttang.com/archive/1640/">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://hacky.wang/blog/20211116/vcFONnqk2U5q.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211116/4WtBgg7Koorr.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211116/Iw0zssr73Lkh.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211116/1rsk4BbUjTqE.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211116/zNyhDok6RjBY.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211116/P0kEbLAzogl1.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211116/bKQuXOuJVeg4.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211116/n2YAuHRAIWg1.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211116/1eHAV59IUnrn.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211116/ITrmOmdOQrfg.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211116/SWK4bhsP2kGS.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211116/ILtsOYomQJad.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211116/kNaAw0lOW30G.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211116/nX0PS5WRVYLK.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211116/7bQWAgsg4hYV.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211116/Aeg9gq8mDVwH.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211116/vm8NsSB4DFAW.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211116/FEcQAFinD1w3.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211117/joGUv5hUI3PB.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211117/AHKTwFdBiqi2.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211117/FW0nQVDziO81.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211117/P0NPpd2tzfG2.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211117/ivqYgKMWJA7s.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211117/NjYWRt9snHqd.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20211117/84TTfm6p97tM.png?imageslim">
<meta property="og:updated_time" content="2022-09-14T13:17:47.207Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="WMI调试与检测">
<meta name="twitter:description" content="本文转载于跳跳糖安全社区，原文链接为https://tttang.com/archive/1640/">
<meta name="twitter:image" content="http://hacky.wang/blog/20211116/vcFONnqk2U5q.png?imageslim">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://findream.github.io/2021/11/06/WMI调试与检测/"/>





  <title>WMI调试与检测 | HaCky的安全备忘录</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HaCky的安全备忘录</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-calendar"></i> <br />
            
            日程表
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://findream.github.io/2021/11/06/WMI调试与检测/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HaCky">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HaCky的安全备忘录">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">WMI调试与检测</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-11-06T12:02:11+08:00">
                2021-11-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/windows系统/" itemprop="url" rel="index">
                    <span itemprop="name">windows系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <ul>
<li>本文转载于跳跳糖安全社区，原文链接为<a href="https://tttang.com/archive/1640/" target="_blank" rel="external">https://tttang.com/archive/1640/</a></li>
</ul>
<a id="more"></a>
<h1 id="0x0-前言"><a href="#0x0-前言" class="headerlink" title="0x0 前言"></a>0x0 前言</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这是WMI的第三篇文章，本文主要调式分析WMI消费者的工作原理，进而提出WMI的检测思路。本文首先介绍了本次分析所需要了解的WMI基本组件和底层协议(RPC),然后通过调式网上的RPC客户端和服务端的通信，了解RPC的原理，接着通过分析两个典型的WMI利用(查询数据，执行函数)，了解WMI的检测，由于WMI调试相关资料过少，没有进行自我订正，可能存在错误，或者重大错误，希望有了解的大佬积极斧正。</p>
<h1 id="0x1-WMI组件介绍"><a href="#0x1-WMI组件介绍" class="headerlink" title="0x1 WMI组件介绍"></a>0x1 WMI组件介绍</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这一节内容截取于软件调试补编。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WMI大多数文件都保存在%system32%\wbem文件夹下，其中下面文件是本次调试分析中使用到的<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wbemcore<span class="selector-class">.dll</span>    WMI核心模块</div><div class="line">Wbemprox<span class="selector-class">.dll</span>    WBEM代理，供 WMI应用程序连接WMI服务，包含了IWbemLocator接口的实现(Clocator类)。</div><div class="line">Fastprox<span class="selector-class">.dll</span>    包含了用于进程间调用和RPC通信的类和函数,又称为Microsoft WBEMFast Call Context。</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CIM对象管理器(CIM Object Manager，简称CIMOM）是WMI的核心部件。它负责管理和维护系统中的类和对象，也是 WMI管理程序（消耗器）和 WMI提供器之间进行交互的桥梁。从进程的角度看，CIMOM是工作在WMI服务器进程中的一系列动态链接库，它们利用COM/DCOM 技术相互协作。对外也是以COM接口的形式公开它们的服务。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WBEMCORE.DLL中的CWbemInstance类是描述和管理CIM类实例的一个内部类。包括读取实例的类名(class name)、修改或读取实例的属性值、复制实例数据等。MSDN中公开的IWbemClassObject 接口定义了操作WMI类和实例的基本方法,通过该接口，WMI应用程序可以访问相应的WMI类或实例。可以认为CWbemClass类和CWbemInstance类为实现这一接口的方法而提供的支持类。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WMI应用程序利用DCOM技术来使用WMI服务进程内的WMI服务。DCOM是分布式组件模型的简称，是对COM技术的扩展，目的是使不同计算机上的COM对象可以相互通信。DCOM协议又被称为对象RPC (Object Remote Procedure Call)，是基于标准RPC协议而制定的。</p>
<h1 id="0x2-RPC调试原理"><a href="#0x2-RPC调试原理" class="headerlink" title="0x2 RPC调试原理"></a>0x2 RPC调试原理</h1><h2 id="0x2-1-客户端发送数据"><a href="#0x2-1-客户端发送数据" class="headerlink" title="0x2.1 客户端发送数据"></a>0x2.1 客户端发送数据</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RPC客户端使用<code>NdrClientCall2</code>函数发送和接收数据，<code>NdrClientCall2</code>函数是客户端入口的一个存根函数。<code>NdrClientCall2</code>函数是一个不定参数函数，从第三个参数开始，传入的是调用的服务端函数所需要的参数。<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dc esp</div><div class="line"><span class="number">0055</span>f9e4  <span class="number">003</span>d0d70 <span class="number">003</span>d0caa <span class="number">0055</span>fadc <span class="number">0055</span>fc20  p.=...=...U. .U.  </div><div class="line"><span class="number">0055</span>f9f4  <span class="number">0055</span>fc28 <span class="number">7</span>efde000 cccccccc cccccccc  (.U....~........</div><div class="line">...</div><div class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dc <span class="number">0055</span>fadc</div><div class="line"><span class="number">0055</span>fadc  <span class="number">0055</span>fbd8 <span class="number">00000040</span> <span class="number">0055</span>fd7c <span class="number">0055</span>fc28  ..U.@...|.U.(.U.   &lt;---<span class="number">-0055</span>fbd8调用完成后填入返回值,<span class="number">40</span>作为传入的参数</div><div class="line"><span class="number">0055</span>faec  <span class="number">7</span>efde000 cccccccc cccccccc cccccccc  ...~............</div><div class="line">...</div><div class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dc <span class="number">0055</span>fbd8                </div><div class="line"><span class="number">0055</span>fbd8  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</div><div class="line"><span class="number">0055</span>fbe8  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</div><div class="line"><span class="number">0055</span>fbf8  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</div><div class="line"><span class="number">0055</span>fc08  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</div><div class="line">....</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在MulNdrpInitializeContextFromProc+0x4B处，将参数堆栈保存在pStubMsg.pContext结构体中。<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _MIDL_STUB_MESSAGE <span class="number">0055</span>f60c</div><div class="line">Client!_MIDL_STUB_MESSAGE</div><div class="line">   +<span class="number">0x000</span> RpcMsg           : <span class="number">0x0055f5e0</span> _RPC_MESSAGE</div><div class="line">   ....</div><div class="line">   +<span class="number">0x0c4</span> pContext         : <span class="number">0x0055f70c</span> _NDR_PROC_CONTEXT</div><div class="line">   ....</div><div class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dc <span class="number">0055</span>f70c +<span class="number">0x18</span></div><div class="line"><span class="number">0055</span>f724  <span class="number">0055</span>fadc <span class="number">00000232</span> <span class="number">00000000</span> <span class="number">003</span>d0cb4  ..U<span class="number">.2</span>.........=.</div><div class="line"><span class="number">0055</span>f734  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</div><div class="line">...</div><div class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dc <span class="number">0055</span>fadc </div><div class="line"><span class="number">0055</span>fadc  <span class="number">0055</span>fbd8 <span class="number">00000040</span> <span class="number">0055</span>fd7c <span class="number">0055</span>fc28  ..U.@...|.U.(.U.</div><div class="line"><span class="number">0055</span>faec  <span class="number">7</span>efde000 cccccccc cccccccc cccccccc  ...~............</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NdrpClientMarshal函数相当于格式化参数等所需要的数据，便于远程调用，在函数调用之前，可以看到RpcMsg-&gt;Buffer并不存在数据，但是在调用NdrpClientMarshal之后，已经将[In]参数传入RpcMsg-&gt;Buffer中(可能_RPC_MESSAGE结构的地址不一样是因为这是两次不同的调试)。<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _RPC_MESSAGE <span class="number">0055</span>f5e0</div><div class="line">Client!_RPC_MESSAGE</div><div class="line">   +<span class="number">0x000</span> <span class="keyword">Handle</span>           : (<span class="built_in">null</span>) </div><div class="line">   +<span class="number">0x004</span> DataRepresentation : <span class="number">0x22c</span></div><div class="line">   +<span class="number">0x008</span> Buffer           : (<span class="built_in">null</span>) </div><div class="line">   <span class="params">...</span>.</div><div class="line"></div><div class="line"><span class="number">0</span>:<span class="number">000</span>&gt;  dt _RPC_MESSAGE <span class="number">0040</span>f3b4</div><div class="line">Client!_RPC_MESSAGE</div><div class="line">   +<span class="number">0x000</span> <span class="keyword">Handle</span>           : <span class="number">0x004dbb78</span> <span class="literal">Void</span></div><div class="line">   +<span class="number">0x004</span> DataRepresentation : <span class="number">0x22c</span></div><div class="line">   +<span class="number">0x008</span> Buffer           : <span class="number">0x004dc2d0</span> <span class="literal">Void</span></div><div class="line">   <span class="params">...</span>.</div><div class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dc <span class="number">004</span>dc2d0</div><div class="line"><span class="number">004</span>dc2d0  <span class="number">00000040</span> <span class="number">00010000</span> <span class="number">551</span>d88b0 <span class="number">4283</span>b831  @<span class="params">...</span><span class="params">...</span><span class="params">...</span>.U1..B</div><div class="line"><span class="number">004</span>dc2e0  <span class="number">6527</span>cda1 <span class="number">289</span>fe459 <span class="number">00000001</span> <span class="number">8</span>a885d04  ..<span class="string">'eY..(.....]..</span></div><div class="line"><span class="string">004dc2f0  11c91ceb 0008e89f 6048102b 00000002  ........+.H`....</span></div><div class="line"><span class="string">004dc300  00010001 551d88b0 4283b831 6527cda1  .......U1..B..'</span>e</div><div class="line"><span class="number">004</span>dc310  <span class="number">289</span>fe459 <span class="number">00000001</span> <span class="number">6</span>cb71c2c <span class="number">45409812</span>  Y..(<span class="params">...</span>.,..l..@E</div><div class="line"><span class="number">004</span>dc320  <span class="number">00000003</span> <span class="number">00000000</span> <span class="number">00000001</span> baadf00d  <span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span>.</div><div class="line"><span class="number">004</span>dc330  baadf00d baadf00d baadf00d baadf00d  <span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span>.</div><div class="line"><span class="number">004</span>dc340  baadf00d baadf00d baadf00d baadf00d  <span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span>.</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在经过NdrpClientMarshal函数序列化之后，调用NdrpSendReceive函数发送NDR数据<br><figure class="highlight llvm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>:<span class="number">000</span>&gt; kn</div><div class="line"> # ChildEBP RetAddr  </div><div class="line"><span class="number">00</span> <span class="number">0040</span>f<span class="number">334</span> <span class="number">77090</span>da<span class="number">2</span> RPCRT<span class="number">4</span><span class="title">!OSF_CCALL</span>::SendReceiveHelper</div><div class="line"><span class="number">01</span> <span class="number">0040</span>f<span class="number">35</span><span class="keyword">c</span> <span class="number">7704</span>b<span class="number">313</span> RPCRT<span class="number">4</span><span class="title">!OSF_CLIENT_MESSAGE_SENDER</span>::SendReceive+<span class="number">0x35</span></div><div class="line"><span class="number">02</span> <span class="number">0040</span>f<span class="number">36</span><span class="keyword">c</span> <span class="number">770373</span>f<span class="number">9</span> RPCRT<span class="number">4</span><span class="title">!OSF_CCALL</span>::SendReceive+<span class="number">0x13</span></div><div class="line"><span class="number">03</span> <span class="number">0040</span>f<span class="number">37</span><span class="keyword">c</span> <span class="number">770380</span>bb RPCRT<span class="number">4</span><span class="title">!I_RpcSendReceive</span>+<span class="number">0x28</span></div><div class="line"><span class="number">04</span> <span class="number">0040</span>f<span class="number">390</span> <span class="number">7703808</span>a RPCRT<span class="number">4</span><span class="title">!NdrSendReceive</span>+<span class="number">0x31</span></div><div class="line"><span class="number">05</span> <span class="number">0040</span>f<span class="number">39</span><span class="keyword">c</span> <span class="number">770</span>d<span class="number">0149</span> RPCRT<span class="number">4</span><span class="title">!NdrpSendReceive</span>+<span class="number">0x9</span></div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在OSF_CCALL::SendReceiveHelper+0x48处，将RpcMsg-&gt;Buffer赋值到OSF_CCALL类偏移0x100处，接着调用OSF_CCALL::FastSendReceive函数继续发送数据。<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">*(this + <span class="number">64</span>) = <span class="built_in">a2</span>-&gt;<span class="keyword">Buffer; </span>                 // 会将参数列表复制到<span class="keyword">buffer中</span></div><div class="line"><span class="keyword">v6 </span>= OSF_CCALL::FastSendReceive(this, <span class="built_in">a2</span>, <span class="built_in">a3</span>)<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<h2 id="0x2-2-服务端接收数据"><a href="#0x2-2-服务端接收数据" class="headerlink" title="0x2.2 服务端接收数据"></a>0x2.2 服务端接收数据</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;从相关介绍中，我了解到NdrServerCall2作为服务端入口函数存在的，但是服务端并不直接调用NdrServerCall2接收和传送客户端的数据。有关服务端在进行PRC调用的时候，接收，调用，以及返回数据的函数堆栈如下：<br><figure class="highlight llvm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>:<span class="number">003</span>&gt; kn</div><div class="line"> # ChildEBP RetAddr  </div><div class="line"><span class="number">00</span> <span class="number">00</span>cff<span class="number">3</span><span class="keyword">cc</span> <span class="number">77055</span>a<span class="number">57</span> Server<span class="title">!Add</span></div><div class="line"><span class="number">01</span> <span class="number">00</span>cff<span class="number">3</span>ec <span class="number">770</span>d<span class="number">05</span>f<span class="number">1</span> RPCRT<span class="number">4</span><span class="title">!Invoke</span>+<span class="number">0x2a</span></div><div class="line"><span class="number">02</span> <span class="number">00</span>cff<span class="number">7</span>f<span class="number">0</span> <span class="number">770</span>d<span class="number">104</span>e RPCRT<span class="number">4</span><span class="title">!NdrStubCall2</span>+<span class="number">0x2ea</span></div><div class="line"><span class="number">03</span> <span class="number">00</span>cff<span class="number">80</span><span class="keyword">c</span> <span class="number">77055</span>fe<span class="number">3</span> RPCRT<span class="number">4</span><span class="title">!NdrServerCall2</span>+<span class="number">0x19</span></div><div class="line"><span class="number">04</span> <span class="number">00</span>cff<span class="number">844</span> <span class="number">77056483</span> RPCRT<span class="number">4</span><span class="title">!DispatchToStubInCNoAvrf</span>+<span class="number">0x46</span></div><div class="line"><span class="number">05</span> <span class="number">00</span>cff<span class="number">89</span><span class="keyword">c</span> <span class="number">7705635</span>d RPCRT<span class="number">4</span><span class="title">!RPC_INTERFACE</span>::DispatchToStubWorker+<span class="number">0x158</span></div><div class="line"><span class="number">06</span> <span class="number">00</span>cff<span class="number">8</span><span class="keyword">c</span><span class="number">0</span> <span class="number">77097</span>ddd RPCRT<span class="number">4</span><span class="title">!RPC_INTERFACE</span>::DispatchToStub+<span class="number">0x90</span></div><div class="line"><span class="number">07</span> <span class="number">00</span>cff<span class="number">94</span><span class="keyword">c</span> <span class="number">7709812</span><span class="keyword">c</span> RPCRT<span class="number">4</span><span class="title">!OSF_SCALL</span>::DispatchHelper+<span class="number">0x23f</span></div><div class="line"><span class="number">08</span> <span class="number">00</span>cff<span class="number">960</span> <span class="number">77098371</span> RPCRT<span class="number">4</span><span class="title">!OSF_SCALL</span>::DispatchRPCCall+<span class="number">0xf5</span></div><div class="line"><span class="number">09</span> <span class="number">00</span>cff<span class="number">98</span><span class="keyword">c</span> <span class="number">77098910</span> RPCRT<span class="number">4</span><span class="title">!OSF_SCALL</span>::ProcessReceivedPDU+<span class="number">0x223</span></div><div class="line"><span class="number">0</span>a <span class="number">00</span>cff<span class="number">9</span>ac <span class="number">77098</span>b<span class="number">0</span><span class="keyword">c</span> RPCRT<span class="number">4</span><span class="title">!OSF_SCALL</span>::BeginRpcCall+<span class="number">0x123</span></div><div class="line"><span class="number">0</span>b <span class="number">00</span>cffa<span class="number">08</span> <span class="number">770</span>a<span class="number">749</span>f RPCRT<span class="number">4</span><span class="title">!OSF_SCONNECTION</span>::ProcessReceiveComplete+<span class="number">0x1e1</span></div><div class="line"><span class="number">0</span><span class="keyword">c</span> <span class="number">00</span>cffa<span class="number">1</span><span class="keyword">c</span> <span class="number">770</span>bbfbf RPCRT<span class="number">4</span><span class="title">!ProcessConnectionServerReceivedEvent</span>+<span class="number">0x1c</span></div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在OSF_SCALL::DispatchHelper函数中，会调用RPC_INTERFACE::DispatchToStub函数，其中第二个参数应该为_RPC_MESSAGE结构体(堆栈中应为第一个，因为又在this指针)<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">v13 = RPC_INTERFACE::DispatchToStub(v2, (this + <span class="number">196</span>), <span class="number">0</span>, v16, &amp;v18);<span class="comment">// &lt;-----this+196为_RPC_MESSAGE</span></div><div class="line"><span class="number">0</span>:<span class="number">004</span>&gt; dc esp</div><div class="line"><span class="number">00</span>d5facc  <span class="number">003</span>b192c <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00</span>d5faec  ,.;.............</div><div class="line"><span class="number">00</span>d5fadc  <span class="number">003</span>b1670 <span class="number">003</span>b1868 <span class="number">00000000</span> <span class="number">003</span>acca8  p.;.h.;.......:.</div><div class="line"><span class="number">00</span>d5faec  <span class="number">003</span>b17f0 <span class="number">00000000</span> <span class="number">00000400</span> <span class="number">00</span>d5fb04  ..;............</div><div class="line"><span class="number">0</span>:<span class="number">004</span>&gt; dt _RPC_MESSAGE <span class="number">003</span>b192c</div><div class="line">Server!_RPC_MESSAGE</div><div class="line">   +<span class="number">0x000</span> Handle           : <span class="number">0x003b1868</span> Void</div><div class="line">   +<span class="number">0x004</span> DataRepresentation : <span class="number">0x10</span></div><div class="line">   +<span class="number">0x008</span> Buffer           : <span class="number">0x003b1ad0</span> Void</div><div class="line">   +<span class="number">0x00c</span> BufferLength     : <span class="number">4</span></div><div class="line">   +<span class="number">0x010</span> ProcNum          : <span class="number">0</span></div><div class="line">   .....</div><div class="line"><span class="number">0</span>:<span class="number">004</span>&gt; dc <span class="number">003</span>b1ad0</div><div class="line"><span class="number">003</span>b1ad0  <span class="number">00000040</span> <span class="number">00010000</span> <span class="number">551</span>d88b0 <span class="number">4283</span>b831  @..........U1..B</div><div class="line"><span class="number">00</span>d5fadc  <span class="number">003</span>b1670 <span class="number">003</span>b1868 <span class="number">00000000</span> <span class="number">003</span>acca8  p.;.h.;.......:.</div><div class="line"><span class="number">00</span>d5faec  <span class="number">003</span>b17f0 <span class="number">00000000</span> <span class="number">00000400</span> <span class="number">00</span>d5fb04  ..;.............</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;接着，调用DispatchToStubInCNoAvrf函数，其目的是将_RPC_MESSAGE传入NdrServerCall2。然后调用NdrStubCall2函数。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">RPCRT4!DispatchToStubInCNoAvrf:</div><div class="line">77055fcc 6a0c            <span class="keyword">push</span>    <span class="number">0Ch</span></div><div class="line">77055fce 68f85f0577      <span class="keyword">push</span>    offset RPCRT4!_imp_load__FreeAddrInfoW+<span class="number">0x1a8</span> (77055ff8)</div><div class="line">77055fd3 e83506feff      <span class="keyword">call</span>    RPCRT4!_SEH_prolog4 (<span class="number">7703660d</span>)</div><div class="line">77055fd8 33f6            <span class="keyword">xor</span>     <span class="built_in">esi</span>,<span class="built_in">esi</span></div><div class="line">77055fda 8975fc          <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">4</span>],<span class="built_in">esi</span></div><div class="line">77055fdd ff750c          <span class="keyword">push</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">0Ch</span>]</div><div class="line">77055fe0 ff5508          <span class="keyword">call</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">8</span>]    <span class="built_in">ss</span>:002b:00d5fa50=&#123;Server!ILT+<span class="number">4690</span>(_NdrServerCall2 (<span class="number">01310257</span>)&#125;</div><div class="line">77055fe3 c745fcfeffffff  <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">4</span>],<span class="number">0FFFFFFFEh</span></div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;其实，NdrStubCall2函数主要作用是根据_RPC_MESSAGE提供的pRpcMsg-&gt;ProcNum信息，获取服务端内对应的函数，根据pRpcMsg-&gt;Buffer获取参数，继而调用Invoke函数。以下是部分代码。另外，Marshal NDR数据的时候，也是和之前客户端相反的，客户端先Marshal成NDR数据，然后发送，等接收后在UnMarshal。而服务端是先UnMarshal，然后在执行，最后Marshal。<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">DispatchTable_ = pRpcMsg_[8];</div><div class="line">if ( !DispatchTable_ )</div><div class="line">DispatchTable_ = DispatchTable;</div><div class="line">pFunc = DispatchTable_[ProcNum];</div><div class="line">ArgNum = StackSize &gt;&gt; 2;</div><div class="line">v26 = StackSize &gt;&gt; 2;</div><div class="line">if ( StackSize &gt;&gt; 2 &amp;&amp; (OptFlags-&gt;Unused &amp; 4) != 0 &amp;&amp; (v42 &amp; 8) == 0 )</div><div class="line">v26 = --ArgNum;</div><div class="line">pArgBuffer_ = pArgBuffer;</div><div class="line">returnValue = Invoke(pFunc, pArgBuffer, ArgNum);// &lt;------</div><div class="line">if ( (OptFlags-&gt;Unused &amp; 4) == 0 )</div><div class="line">goto LABEL_26;</div><div class="line">if ( (v42 &amp; 8) == 0 )</div><div class="line">*&amp;pArgBuffer_[4 * ArgNum] = returnValue;</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在Invoke函数，显然可以看到将两个参数传入需要被调用函数中。<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>:<span class="number">004</span>&gt; dc esp</div><div class="line"><span class="number">00</span>d5f5dc  <span class="number">003</span>b1188 <span class="number">00000040</span> <span class="number">00000202</span> <span class="number">00000002</span>  ..;.@...........</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;很显然,当调用完NdrpServerMarshal之后，便在pRpcMsg-&gt;Buffer中保存了结果<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">0:002&gt; dt _MIDL_STUB_MESSAGE  00a2f1f0</div><div class="line">Server!_MIDL_STUB_MESSAGE</div><div class="line">   +0x000 RpcMsg           : 0x003b192c _RPC_MESSAGE</div><div class="line">   +0x004 Buffer           : 0x003b0f48  <span class="string">""</span></div><div class="line">   +0x008 BufferStart      : 0x003b1fd0  <span class="string">"???"</span></div><div class="line">   +0x00c BufferEnd        : 0x003b1fd8  <span class="string">".???"</span></div><div class="line">0:002&gt; dt _RPC_MESSAGE 003b192c </div><div class="line">Server!_RPC_MESSAGE</div><div class="line">   +0x000 Handle           : 0x003b1868 Void</div><div class="line">   +0x004 DataRepresentation : 0x10</div><div class="line">   +0x008 Buffer           : 0x003b0f40 Void</div><div class="line">   +0x00c BufferLength     : 0x24</div><div class="line">   +0x010 ProcNum          : 1</div><div class="line">   +0x014 TransferSyntax   : 0x003accd4 _RPC_SYNTAX_IDENTIFIER</div><div class="line">   +0x018 RpcInterfaceInformation : 0x003accbc Void</div><div class="line">   +0x01c ReservedForRuntime : 0x003b1958 Void</div><div class="line">   +0x020 ManagerEpv       : (<span class="literal">null</span>) </div><div class="line">   +0x024 ImportContext    : 0xbaadf00d Void</div><div class="line">   +0x028 RpcFlags         : 0</div><div class="line">0:002&gt; dc 003b0f40</div><div class="line">003b0f40  00000004 00000000 00000000 00000000  <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></div><div class="line">003b0f50  00000000 00000000 00000000 00000000  <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></div><div class="line">003b0f60  00000000 00000000 00000000 00000000  <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.</div></pre></td></tr></table></figure></p>
<h2 id="0x2-3-服务端发送数据"><a href="#0x2-3-服务端发送数据" class="headerlink" title="0x2.3 服务端发送数据"></a>0x2.3 服务端发送数据</h2><p>在OSF_SCALL::DispatchHelper函数中，在执行完RPC_INTERFACE::DispatchToStub函数(执行Invoke函数)之后，便会调用OSF_SCALL::Send函数，第二个参数(this + 196)是不是很熟悉，保存的就是_RPC_MESSAGE结构体。看来在传输过程中，RPC主要传输的是_RPC_MESSAGE。<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">OSF_SCALL::Send(this, (this + <span class="number">196</span>));      <span class="comment">// &lt;------发送</span></div><div class="line"><span class="number">0</span>:<span class="number">002</span>&gt; dc esp</div><div class="line"><span class="number">00</span>a2f6b4  <span class="number">003</span>b192c <span class="number">003</span>b1670 <span class="number">003</span>b1868 <span class="number">00000000</span>  ,.;.p.;.h.;.....</div><div class="line"><span class="number">00</span>a2f6c4  <span class="number">003</span>acca8 <span class="number">003</span>b17f0 <span class="number">00000000</span> <span class="number">00000000</span>  ..:...;.........</div><div class="line">....</div><div class="line"><span class="number">0</span>:<span class="number">002</span>&gt; dt _RPC_MESSAGE <span class="number">003</span>b192c </div><div class="line">Server!_RPC_MESSAGE</div><div class="line">   +<span class="number">0x000</span> Handle           : <span class="number">0x003b1868</span> Void</div><div class="line">   +<span class="number">0x004</span> DataRepresentation : <span class="number">0x10</span></div><div class="line">   +<span class="number">0x008</span> Buffer           : <span class="number">0x003b0f40</span> Void</div><div class="line">   +<span class="number">0x00c</span> BufferLength     : <span class="number">8</span></div><div class="line">   +<span class="number">0x010</span> ProcNum          : <span class="number">1</span></div><div class="line">   +<span class="number">0x014</span> TransferSyntax   : <span class="number">0x003accd4</span> _RPC_SYNTAX_IDENTIFIER</div><div class="line">   +<span class="number">0x018</span> RpcInterfaceInformation : <span class="number">0x003accbc</span> Void</div><div class="line">   +<span class="number">0x01c</span> ReservedForRuntime : <span class="number">0x003b1958</span> Void</div><div class="line">   +<span class="number">0x020</span> ManagerEpv       : (null) </div><div class="line">   +<span class="number">0x024</span> ImportContext    : <span class="number">0xbaadf00d</span> Void</div><div class="line">   +<span class="number">0x028</span> RpcFlags         : <span class="number">0</span></div><div class="line"><span class="number">0</span>:<span class="number">002</span>&gt; dc <span class="number">003</span>b0f40</div><div class="line"><span class="number">003</span>b0f40  <span class="number">00000004</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</div><div class="line"><span class="number">003</span>b0f50  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</div><div class="line"><span class="number">003</span>b0f60  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</div><div class="line"><span class="number">003</span>b0f70  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</div></pre></td></tr></table></figure></p>
<h2 id="0x2-4-客户端接收数据"><a href="#0x2-4-客户端接收数据" class="headerlink" title="0x2.4 客户端接收数据"></a>0x2.4 客户端接收数据</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在OSF_CCALL::SendNextFragment中，调用OSF_CCONNECTION::SendFragment函数，其中，这里的a4，对应的其实是pContext，<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">v6 = OSF_CCONNECTION::SendFragment(</div><div class="line">     *(this + <span class="number">40</span>),</div><div class="line">     v14,</div><div class="line">     this,</div><div class="line">     v23,</div><div class="line">     v24,</div><div class="line">     *(this + <span class="number">54</span>),</div><div class="line">     v21,</div><div class="line">     *(this + <span class="number">53</span>),</div><div class="line">     *(this + <span class="number">57</span>),</div><div class="line">     *(*(this + <span class="number">40</span>) + <span class="number">88</span>) &amp; <span class="number">0x40</span>,</div><div class="line">     v22,</div><div class="line">     v25,</div><div class="line">     a4,</div><div class="line">     a5);</div><div class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dc esi</div><div class="line"><span class="number">0040</span>f308  <span class="number">004</span>dc550 <span class="number">00000000</span> <span class="number">6</span>d4f9985 <span class="number">0040</span>f334  P.M.......Om4.@.</div><div class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dc <span class="number">004</span>dc550 </div><div class="line"><span class="number">004</span>dc550  <span class="number">03020005</span> <span class="number">00000010</span> <span class="number">00000060</span> <span class="number">00000002</span>  ........`.......</div><div class="line"><span class="number">004</span>dc560  <span class="number">00000048</span> <span class="number">00000000</span> <span class="number">00000040</span> <span class="number">53435052</span>  H.......@...RPCS</div><div class="line"><span class="number">004</span>dc570  <span class="number">65767265</span> <span class="number">00000072</span> <span class="number">00000000</span> <span class="number">00000000</span>  erver...........</div><div class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dc <span class="number">004</span>dc550+<span class="number">18</span></div><div class="line"><span class="number">004</span>dc568  <span class="number">00000040</span> <span class="number">53435052</span> <span class="number">65767265</span> <span class="number">00000072</span>  @...RPCServer...</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在OSF_CCALL::FastSendReceive函数中，接着程序会调用<code>OSF_CCALL::ActuallyProcessPDU</code>函数，其中Src保存的是pContxt，跟准确的表达也就是[InOut]参数，在调用之前，可以看到BufferLength为4，即传入了一个参数的大小，当调用完成之后，BufferLength变为了48，且buffer中也有了返回的结果。<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">v6 = OSF_CCALL<span class="type">::ActuallyProcessPDU</span>(this, Src, v46, a2, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _RPC_MESSAGE <span class="number">0040</span>f3b4</div><div class="line">Client!_RPC_MESSAGE</div><div class="line">   +<span class="number">0x000</span> <span class="keyword">Handle</span>           : <span class="number">0x004dbb78</span> <span class="literal">Void</span></div><div class="line">   +<span class="number">0x004</span> DataRepresentation : <span class="number">0x22c</span></div><div class="line">   +<span class="number">0x008</span> Buffer           : <span class="number">0x004dc2d0</span> <span class="literal">Void</span></div><div class="line">   +<span class="number">0x00c</span> BufferLength     : <span class="number">4</span></div><div class="line">   +<span class="number">0x010</span> ProcNum          : <span class="number">0</span></div><div class="line">   +<span class="number">0x014</span> TransferSyntax   : <span class="number">0x00000004</span> _RPC_SYNTAX_IDENTIFIER</div><div class="line">   +<span class="number">0x018</span> RpcInterfaceInformation : <span class="number">0x00110d28</span> <span class="literal">Void</span></div><div class="line">   +<span class="number">0x01c</span> ReservedForRuntime : <span class="number">0x77ac59bc</span> <span class="literal">Void</span></div><div class="line">   +<span class="number">0x020</span> ManagerEpv       : <span class="number">0x00000008</span> <span class="literal">Void</span></div><div class="line">   +<span class="number">0x024</span> ImportContext    : <span class="number">0x77a39a3a</span> <span class="literal">Void</span></div><div class="line">   +<span class="number">0x028</span> RpcFlags         : <span class="number">0</span></div><div class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dc <span class="number">004</span>dc2d0 </div><div class="line"><span class="number">004</span>dc2d0  <span class="number">00000040</span> <span class="number">00010000</span> <span class="number">551</span>d88b0 <span class="number">4283</span>b831  @<span class="params">...</span><span class="params">...</span><span class="params">...</span>.U1..B</div><div class="line"><span class="number">004</span>dc2e0  <span class="number">6527</span>cda1 <span class="number">289</span>fe459 <span class="number">00000001</span> <span class="number">8</span>a885d04  ..<span class="string">'eY..(.....]..</span></div><div class="line"><span class="string">004dc2f0  11c91ceb 0008e89f 6048102b 00000002  ........+.H`....</span></div><div class="line"><span class="string">004dc300  00010001 551d88b0 4283b831 6527cda1  .......U1..B..'</span>e</div><div class="line"><span class="comment">//调用完成之后</span></div><div class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _RPC_MESSAGE <span class="number">0040</span>f3b4</div><div class="line">Client!_RPC_MESSAGE</div><div class="line">   +<span class="number">0x000</span> <span class="keyword">Handle</span>           : <span class="number">0x004dbb78</span> <span class="literal">Void</span></div><div class="line">   +<span class="number">0x004</span> DataRepresentation : <span class="number">0x10</span></div><div class="line">   +<span class="number">0x008</span> Buffer           : <span class="number">0x004dc568</span> <span class="literal">Void</span></div><div class="line">   +<span class="number">0x00c</span> BufferLength     : <span class="number">0x48</span></div><div class="line">   +<span class="number">0x010</span> ProcNum          : <span class="number">0</span></div><div class="line">   +<span class="number">0x014</span> TransferSyntax   : <span class="number">0x00000004</span> _RPC_SYNTAX_IDENTIFIER</div><div class="line">   +<span class="number">0x018</span> RpcInterfaceInformation : <span class="number">0x00110d28</span> <span class="literal">Void</span></div><div class="line">   +<span class="number">0x01c</span> ReservedForRuntime : <span class="number">0x77ac59bc</span> <span class="literal">Void</span></div><div class="line">   +<span class="number">0x020</span> ManagerEpv       : <span class="number">0x00000008</span> <span class="literal">Void</span></div><div class="line">   +<span class="number">0x024</span> ImportContext    : <span class="number">0x77a39a3a</span> <span class="literal">Void</span></div><div class="line">   +<span class="number">0x028</span> RpcFlags         : <span class="number">0x1000</span></div><div class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dc <span class="number">004</span>dc568</div><div class="line"><span class="number">004</span>dc568  <span class="number">00000040</span> <span class="number">53435052</span> <span class="number">65767265</span> <span class="number">00000072</span>  @<span class="params">...</span>RPCServer<span class="params">...</span></div><div class="line"><span class="number">004</span>dc578  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  <span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span>.</div><div class="line"><span class="number">004</span>dc588  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  <span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span>.</div><div class="line"><span class="number">004</span>dc598  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  <span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span>.</div><div class="line"><span class="number">004</span>dc5a8  <span class="number">00000000</span> <span class="number">00000000</span> baadf00d baadf00d  <span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span>.</div><div class="line"><span class="number">004</span>dc5b8  baadf00d baadf00d baadf00d baadf00d  <span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span>.</div><div class="line"><span class="number">004</span>dc5c8  baadf00d baadf00d baadf00d baadf00d  <span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span>.</div><div class="line"><span class="number">004</span>dc5d8  baadf00d baadf00d baadf00d baadf00d  <span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span>.</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;经过NdrpSendReceive函数之后，_RPC_MESSAGE.buffer(同_MIDL_STUB_MESSAGE.Buffer)却存储参数堆栈<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _MIDL_STUB_MESSAGE <span class="number">0040</span>f3e0</div><div class="line">Client!_MIDL_STUB_MESSAGE</div><div class="line">   +<span class="number">0x000</span> RpcMsg           : <span class="number">0x0040f3b4</span> _RPC_MESSAGE</div><div class="line">   +<span class="number">0x004</span> Buffer           : <span class="number">0x004dc568</span>  <span class="string">"@"</span></div><div class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dc <span class="number">004</span>dc568 </div><div class="line"><span class="number">004</span>dc568  <span class="number">00000040</span> <span class="number">53435052</span> <span class="number">65767265</span> <span class="number">00000072</span>  @...RPCServer...</div><div class="line"><span class="number">004</span>dc578  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</div><div class="line"><span class="number">004</span>dc588  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</div><div class="line"><span class="number">004</span>dc598  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</div><div class="line"><span class="number">004</span>dc5a8  <span class="number">00000000</span> <span class="number">00000000</span> baadf00d baadf00d  ................</div></pre></td></tr></table></figure></p>
<h1 id="0x3-WMI调试1——检索信息"><a href="#0x3-WMI调试1——检索信息" class="headerlink" title="0x3 WMI调试1——检索信息"></a>0x3 WMI调试1——检索信息</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本部分以Get-WmiObject -class Win32_Process为例。</p>
<h2 id="0x3-1-WMI连接"><a href="#0x3-1-WMI连接" class="headerlink" title="0x3.1 WMI连接"></a>0x3.1 WMI连接</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>ConnectServerWmi函数</code>的作用是链接WMI服务器，就像之前所说的，位于wminet_utils模块的函数，只是起到存根函数的作用，其最终会调用wbemprox的<code>CLocator::ConnectServe</code>函数。<br>    <img src="http://hacky.wang/blog/20211116/vcFONnqk2U5q.png?imageslim" alt="mark"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在<code>CLocator::ConnectServe</code>函数中，最终会调用<code>CDCOMTrans::DoActualConnection</code>函数，其调用堆栈如下。<br>   <img src="http://hacky.wang/blog/20211116/4WtBgg7Koorr.png?imageslim" alt="mark"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>CDCOMTrans::DoActualConnection</code>函数的主要作用是初始化_COSERVERINFO结构体，或者_COAUTHIDENTITY结构体。_COSERVERINFO结构体是一个包含激活功能的结构体。_COAUTHIDENTITY结构体则是一个包含域名，用户名密码的结构体。</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">typedef struct _COSERVERINFO &#123;</div><div class="line">  <span class="type">DWORD</span>      dwReserved1;</div><div class="line">  <span class="type">LPWSTR</span>     pwszName;</div><div class="line">  <span class="type">COAUTHINFO</span> *pAuthInfo;</div><div class="line">  <span class="type">DWORD</span>      dwReserved2;</div><div class="line">&#125; <span class="type">COSERVERINFO</span>;</div><div class="line">typedef struct _COAUTHIDENTITY &#123;</div><div class="line">  <span class="type">USHORT</span> *<span class="type">User</span>;</div><div class="line">  <span class="type">ULONG</span>  <span class="type">UserLength</span>;</div><div class="line">  <span class="type">USHORT</span> *<span class="type">Domain</span>;</div><div class="line">  <span class="type">ULONG</span>  <span class="type">DomainLength</span>;</div><div class="line">  <span class="type">USHORT</span> *<span class="type">Password</span>;</div><div class="line">  <span class="type">ULONG</span>  <span class="type">PasswordLength</span>;</div><div class="line">  <span class="type">ULONG</span>  <span class="type">Flags</span>;</div><div class="line">&#125; <span class="type">COAUTHIDENTITY</span>;</div></pre></td></tr></table></figure>
<p>   <img src="http://hacky.wang/blog/20211116/Iw0zssr73Lkh.png?imageslim" alt="mark"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最终调用<code>CDCOMTrans::DoActualCCI</code>函数,在<code>CDCOMTrans::DoActualCCI</code>函数中，最终会调用CoCreateInstanceEx函数，CoCreateInstanceEx函数可以在指定的远程计算机上创建与给定 CLSID 关联的单个未初始化对象。而CoCreateInstance也可以创建一个实例，但是CoCreateInstance与CoCreateInstanceEx函数的区别在于CoCreateInstanceEx可以创建远程计算机的实例。 CoCreateInstanceEx函数的第一个参数是CLSID，表示要实例化对象的CLSID。在上一篇文章中，检测远程WMI连接的CLSID的值为8BC3F05E-D86B-11D0-A075-00C04FB68820。这就是为什么只要针对这个CLSID检测就可以判断是WMI远程连接了。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">HRESULT CoCreateInstanceEx(</div><div class="line">  [<span class="keyword">in</span>]      REFCLSID     Clsid,</div><div class="line">  [<span class="keyword">in</span>]      IUnknown     *punkOuter,</div><div class="line">  [<span class="keyword">in</span>]      <span class="built_in">DWORD</span>        dwClsCtx,</div><div class="line">  [<span class="keyword">in</span>]      COSERVERINFO *pServerInfo,</div><div class="line">  [<span class="keyword">in</span>]      <span class="built_in">DWORD</span>        dwCount,</div><div class="line">  [<span class="keyword">in</span>, <span class="keyword">out</span>] MULTI_QI     *pResults</div><div class="line">)<span class="comment">;</span></div><div class="line">v10 = CoCreateInstanceEx(&amp;CLSID_WbemLevel1Login, <span class="number">0</span>, 0x14u, (a3 == <span class="number">0</span> ? a2 : <span class="number">0</span>), 1u, &amp;pResults)<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p><img src="http://hacky.wang/blog/20211116/1rsk4BbUjTqE.png?imageslim" alt="mark"></p>
<h2 id="0x3-2-WMI查询"><a href="#0x3-2-WMI查询" class="headerlink" title="0x3.2 WMI查询"></a>0x3.2 WMI查询</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WMI查询操作，是通过wminet_utils模块的<code>ExecQueryWmi</code>函数调用fastprox模块的CWbemSvcWrapper::XWbemServices::ExecQuery函数，而CWbemSvcWrapper::XWbemServices::ExecQuery的第二第三个参数分别表示执行的查询语句的类型，和SQL语句的内容。WMI拥有自己的查询语句，即WQL。<br><figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">v12</span> = pCurrentNamespace-&gt;</span><span class="function"><span class="title">lpVtbl</span>-&gt;</span>ExecQuery(pCurrentNamespace, strQueryLanguage, strQuery, lFlags, pCtx, ppEnum);</div></pre></td></tr></table></figure></p>
<p><img src="http://hacky.wang/blog/20211116/zNyhDok6RjBY.png?imageslim" alt="mark"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最终经过ole32!ObjectStubless函数调用RPCRT4!NdrClientCall2进行RPC调用。在RPCRT4!NdrClientCall2函数中，经过Marshal，会把参数保存在RPCMSG-&gt;Buffer中。这样做的好处是方便数据的传输。<br>    <img src="http://hacky.wang/blog/20211116/P0kEbLAzogl1.png?imageslim" alt="mark"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;将windbg附加到WmiPrvSE.exe进程即WMI提供程序进程。因为WMI原理简单来说就是WMI消费程序通过WMI核心架构，向WMI提供程序请求数据，WMI提供程序返回相关结果。WmiPrvSE.exe进程其实是X64进程，当windbg中断在<code>call    RPCRT4!Invoke</code>,根据x64函数的调用约定，rcx应该是需要invoke的函数，rdx应该是参数的缓冲区，r9d是参数个数。可以看到，服务端WmiPrvSE.exe接收到了数据，并准备调用CreateInstanceEnumAsync函数实例化Win32_Process。<br>   <img src="http://hacky.wang/blog/20211116/bKQuXOuJVeg4.png?imageslim" alt="mark"><br>   <img src="http://hacky.wang/blog/20211116/n2YAuHRAIWg1.png?imageslim" alt="mark"><br>   <img src="http://hacky.wang/blog/20211116/1eHAV59IUnrn.png?imageslim" alt="mark"></p>
<h2 id="0x3-3-Get方法获取属性值"><a href="#0x3-3-Get方法获取属性值" class="headerlink" title="0x3.3 Get方法获取属性值"></a>0x3.3 Get方法获取属性值</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Get函数最终是通过调用fastprox模块的<code>CWbemObject::Get</code>方法实现的，<code>CWbemObject::Get</code>主要有调用了两个方法，分别是<code>CWbemInstance::GetProperty</code>和<code>CWbemInstance::GetPropertyType</code>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>CWbemInstance::GetProperty</code>函数主要是为了获取指定属性名的属性值，在其底层主要调用了<code>CWbemObject::GetSystemPropertyByName</code>或者<code>CWbemInstance::GetNonsystemPropertyValue</code>函数，前者主要获取的是系统属性值，而后者是获取非系统属性的属性值，在<code>CSystemProperties::FindName</code>函数中，可以看到系统属性有哪些。<br>   <img src="http://hacky.wang/blog/20211116/ITrmOmdOQrfg.png?imageslim" alt="mark"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在调用<code>CWbemObject::GetSystemPropertyByName</code>函数之前，在堆栈中看到需要查看的属性名为__PATH,调用结束后，可以看到返回的是一个CVar结构。CVAR偏移为0x00表示变量的类型，CVAR偏移为0x08，则表示变量的值。</p>
<p>  <img src="http://hacky.wang/blog/20211116/SWK4bhsP2kGS.png?imageslim" alt="mark"><br>  <img src="http://hacky.wang/blog/20211116/ILtsOYomQJad.png?imageslim" alt="mark"></p>
<h2 id="0x3-4-GetNames方法获取属性值"><a href="#0x3-4-GetNames方法获取属性值" class="headerlink" title="0x3.4 GetNames方法获取属性值"></a>0x3.4 GetNames方法获取属性值</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetNames函数最终调用fastprox模块的<code>CWbemObject::GetNames</code>方法。<code>CWbemObject::GetNames</code>函数主要是获取系统和非系统的属性名。通过flag标记，判断是获取系统属性名，亦或是非系统属性名，如果lFlags为0x30，则获取系统属性名，如果为0x40，则仅获取非系统属性名,因为将结果保存SAFEARRAY结构。SAFEARRAY+0x00表示数组的维度，可知这是一个一维数组，然后偏移+0x0C表示数组首地址，该数组有多个元素构成。<br><figure class="highlight elm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">typedef struct tagSAFEARRAY &#123;</div><div class="line">  <span class="type">USHORT</span>         cDims;</div><div class="line">  <span class="type">USHORT</span>         fFeatures;</div><div class="line">  <span class="type">ULONG</span>          cbElements;</div><div class="line">  <span class="type">ULONG</span>          cLocks;</div><div class="line">  <span class="type">PVOID</span>          pvData;</div><div class="line">  <span class="type">SAFEARRAYBOUND</span> rgsabound[1];</div><div class="line">&#125; <span class="type">SAFEARRAY</span>, *<span class="type">LPSAFEARRAY</span>;</div></pre></td></tr></table></figure></p>
<p>   <img src="http://hacky.wang/blog/20211116/kNaAw0lOW30G.png?imageslim" alt="mark"><br>   <img src="http://hacky.wang/blog/20211116/nX0PS5WRVYLK.png?imageslim" alt="mark"><br>   <img src="http://hacky.wang/blog/20211116/7bQWAgsg4hYV.png?imageslim" alt="mark"><br>   <img src="http://hacky.wang/blog/20211116/Aeg9gq8mDVwH.png?imageslim" alt="mark"><br>   <img src="http://hacky.wang/blog/20211116/vm8NsSB4DFAW.png?imageslim" alt="mark"><br>   <img src="http://hacky.wang/blog/20211116/FEcQAFinD1w3.png?imageslim" alt="mark"></p>
<h2 id="0x3-5-总结获取进程信息原理"><a href="#0x3-5-总结获取进程信息原理" class="headerlink" title="0x3.5 总结获取进程信息原理"></a>0x3.5 总结获取进程信息原理</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;其获取进程数据的主要原理是第一次通过调用GetNames方法，获取系统属性名，然后依次调用Get方法获取属性名的属性值，接着第二次调用GetNames方法获取非系统属性值，然后依次调用Get方法获取属性值。</p>
<h1 id="0x4-WMI调试2——执行函数"><a href="#0x4-WMI调试2——执行函数" class="headerlink" title="0x4 WMI调试2——执行函数"></a>0x4 WMI调试2——执行函数</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本节使用的语句为Invoke-WmiMethod -class Win32_Process -Name Create calc.exe。</p>
<h2 id="0x4-1-初始分析"><a href="#0x4-1-初始分析" class="headerlink" title="0x4.1 初始分析"></a>0x4.1 初始分析</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在分析这一部分的时候，因为wminet_utils模块中没有ExecMethod相关的函数，并没有像上面一样通过wminet_utils模块来寻求突破。我们都知道WMI底层是客户端通过RPC协议远程调用服务端的函数，并接收返回值。所以我决定在RPC底层，通过中断NdrClientStub2函数，然后追溯栈回溯的方法确定调用方。最终发现其直接调用了fastprox模块的<code>IWbemServices::ExecMethod</code>函数。</p>
<h2 id="0x4-2-调用ExecMethod方法"><a href="#0x4-2-调用ExecMethod方法" class="headerlink" title="0x4.2 调用ExecMethod方法"></a>0x4.2 调用ExecMethod方法</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>IWbemServices::ExecMethod</code>函数的原型如下，第一个参数是Object的名字，第二个参数为函数名，第5个参数是指向传入参数的类。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function">HRESULT <span class="title">ExecMethod</span>(<span class="params"></span></span></div><div class="line"><span class="function"><span class="params">  [<span class="keyword">in</span>]  <span class="keyword">const</span> BSTR       strObjectPath,</span></span></div><div class="line"><span class="function"><span class="params">  [<span class="keyword">in</span>]  <span class="keyword">const</span> BSTR       strMethodName,</span></span></div><div class="line"><span class="function"><span class="params">  [<span class="keyword">in</span>]  <span class="keyword">long</span>             lFlags,</span></span></div><div class="line"><span class="function"><span class="params">  [<span class="keyword">in</span>]  IWbemContext     *pCtx,</span></span></div><div class="line"><span class="function"><span class="params">  [<span class="keyword">in</span>]  IWbemClassObject *pInParams,</span></span></div><div class="line"><span class="function"><span class="params">  [<span class="keyword">out</span>] IWbemClassObject **ppOutParams,</span></span></div><div class="line"><span class="function"><span class="params">  [<span class="keyword">out</span>] IWbemCallResult  **ppCallResult</span></span></div><div class="line"><span class="function"><span class="params"></span>)</span>;</div></pre></td></tr></table></figure></p>
<p>   <img src="http://hacky.wang/blog/20211117/joGUv5hUI3PB.png?imageslim" alt="mark"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;微软官方对pInParams的解释是<strong><em>如果执行方法不需要输入参数，则可能为NULL。否则，它指向一个 IWbemClassObject</em></strong>,并从<a href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/creating-parameters-objects-in-c--" target="_blank" rel="external">https://docs.microsoft.com/en-us/windows/win32/wmisdk/creating-parameters-objects-in-c–</a>这里了解到更详细的介绍。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;根据微软的介绍，创建__PARAMETERS的实例的步骤如下:</p>
<ul>
<li><ol>
<li>确定包含方法定义的类的类路径。</li>
</ol>
</li>
<li><ol>
<li>使用从IWbemProviderInit::Initialize传入的类路径和IWbemServices指针，调用IWbemClassObject::GetMethod来检索输入和输出参数类。GetMethod方法返回一个IWbemClassObject用于访问每个类的指针。</li>
</ol>
</li>
<li><ol>
<li>使用输出类的IWbemClassObject指针，调用IWbemClassObject::SpawnInstance以创建类的实例。</li>
</ol>
</li>
<li><ol>
<li>通过设置与输出值对应的属性来填充类实例，如果方法有返回值，则设置ReturnValue属性。</li>
</ol>
</li>
<li><ol>
<li>通过IWbemObjectSink::Indicate方法将__PARAMETERS实例传递回调用者。</li>
</ol>
</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;根据上述描述，我了解到了如果要创建这个一个__PARAMETERS实例，首先需要调用IWbemClassObject::SpawnInstance以创建类的实例，然后设置与输出值对应的属性来填充类实例。这里填充类实例是使用了<code>CWbemInstance::Put</code>函数。最终把SpawnInstance创建创建类的实例传入IWbemServices::ExecMethod的pInParams参数。</p>
<h2 id="0x4-3-填充类实例"><a href="#0x4-3-填充类实例" class="headerlink" title="0x4.3 填充类实例"></a>0x4.3 填充类实例</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WMI使用fastprox模块的<code>CWbemInstance::Put</code>函数设置属性值，函数原型如下,第二个参数是待修改的属性名，而第4个参数是属性值。这是一个VARIANT结构。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> __stdcall CWbemInstance::Put(CWbemInstance *<span class="keyword">this</span>, LPCWSTR wszName, LONG lFlags, VARIANT *pVal, CIMTYPE vtType)</div></pre></td></tr></table></figure></p>
<p>   <img src="http://hacky.wang/blog/20211117/AHKTwFdBiqi2.png?imageslim" alt="mark"><br>   <img src="http://hacky.wang/blog/20211117/FW0nQVDziO81.png?imageslim" alt="mark"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>CWbemInstance::Put</code>底层主要通过<code>CWbemInstance::SetPropValue</code>函数实现，首先判断是否是系统属性名，然后通过<code>CClassPart::FindPropertyInfo</code>函数获取Property信息，接着依次调用<code>CInstancePart::SetActualValue</code>函数，<code>CUntypedValue::LoadFromCVar</code>函数。和<code>CFastHeap::AllocateString</code>函数。并在<code>CFastHeap::AllocateString</code>完成属性值的设置。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;调用<code>CInstancePart::SetActualValue</code>函数，其类是CInstancePart，父类为CWbemInstance类，显然可以得出在CWbemInstance+0x68的偏移处为<code>CInstancePart</code>类。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CInstancePart::SetActualValue((<span class="keyword">this</span> + <span class="number">0x68</span>), v5, value);<span class="comment">// this+0x68===&gt;CInstancePart</span></div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;接着调用<code>CUntypedValue::LoadFromCVar</code>,其中，第三个参数为<code>(this + 0x6C)</code>,其实这是一个CFastHeap类，其位于<code>CInstancePart</code>类的第0x6C的偏移处。<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">v8 = CUntypedValue::LoadFromCVar(v16, a3, v15, (this + 0x6C), &amp;v17, v6);// this + 0x6C ====&gt;CFastHeap</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最终调用<code>CFastHeap::AllocateString</code>函数，完成对InParameters对象的赋值。v6其实就是等于[this]+pIndex。<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">CFastHeap:</span>:AllocateString(fastheap, *(v35 + <span class="number">2</span>), <span class="variable">&amp;a2</span>)</div></pre></td></tr></table></figure></p>
<p>  <img src="http://hacky.wang/blog/20211117/P0NPpd2tzfG2.png?imageslim" alt="mark"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;简单总结一下，假设CWbemInstance位于0x06505990，通过调用<code>CInstancePart::SetActualValue</code>函数，可知CInstancePart的地址位于<code>CWbemInstance + 0x68</code>即0x065059f8。然后通过调用<code>CUntypedValue::LoadFromCVar</code>函数可知，CFastHeap的地址位于<code>CInstancePart + 0x6C</code>即06505ar64的地址。通过获取对CFastHeap取值，就可以知道参数的地址。<br><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">CWbemInstance ===<span class="function">=&gt;</span> <span class="number">0x06505990</span></div><div class="line">CWbemInstance + <span class="number">0x68</span> ===<span class="function">=&gt;</span> CInstancePart:<span class="number">065059</span>f8</div><div class="line">CInstancePart + <span class="number">0x6C</span> ===<span class="function">=&gt;</span> CFastHeap:<span class="number">06505</span>ar64</div></pre></td></tr></table></figure></p>
<p>  <img src="http://hacky.wang/blog/20211117/ivqYgKMWJA7s.png?imageslim" alt="mark"><br>  <img src="http://hacky.wang/blog/20211117/NjYWRt9snHqd.png?imageslim" alt="mark"><br>  <img src="http://hacky.wang/blog/20211117/84TTfm6p97tM.png?imageslim" alt="mark"></p>
<h2 id="0x4-4-总结"><a href="#0x4-4-总结" class="headerlink" title="0x4.4 总结"></a>0x4.4 总结</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;根据上述，我们可知，<code>IWbemServices::ExecMethod</code>函数的第一，第二，第五个参数分别表示的是Class名，函数名，参数类。其中参数可以通过参数类[__PARAMETERS+0x68+0x6C]获取。由此如果需要检测WMI通过Invoke-Method的方法进行创建函数，设置注册表等行为，可以通过检测<code>IWbemServices::ExecMethod</code>的调用实现。</p>
<h1 id="0x5-参考文献"><a href="#0x5-参考文献" class="headerlink" title="0x5 参考文献"></a>0x5 参考文献</h1><ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/creating-parameters-objects-in-c--" target="_blank" rel="external">Creating Parameters Objects in C++</a></li>
<li>软件调试补篇</li>
<li><a href="https://github.com/dotnet/docs/blob/main/docs/framework/unmanaged-api/wmi/index.md" target="_blank" rel="external">https://github.com/dotnet/docs/blob/main/docs/framework/unmanaged-api/wmi/index.md</a></li>
<li><a href="https://www.cnblogs.com/wanghaiyang1930/p/4469222.html" target="_blank" rel="external">Windows RPC Demo实现</a></li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/11/06/WMI检测思路与实现/" rel="next" title="WMI检测思路与实现">
                <i class="fa fa-chevron-left"></i> WMI检测思路与实现
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/11/13/WMI攻守之道/" rel="prev" title="WMI的攻守之道">
                WMI的攻守之道 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">HaCky</p>
              <p class="site-description motion-element" itemprop="description">我是最菜的HaCky呀</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">73</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#0x0-前言"><span class="nav-number">1.</span> <span class="nav-text">0x0 前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x1-WMI组件介绍"><span class="nav-number">2.</span> <span class="nav-text">0x1 WMI组件介绍</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x2-RPC调试原理"><span class="nav-number">3.</span> <span class="nav-text">0x2 RPC调试原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x2-1-客户端发送数据"><span class="nav-number">3.1.</span> <span class="nav-text">0x2.1 客户端发送数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x2-2-服务端接收数据"><span class="nav-number">3.2.</span> <span class="nav-text">0x2.2 服务端接收数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x2-3-服务端发送数据"><span class="nav-number">3.3.</span> <span class="nav-text">0x2.3 服务端发送数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x2-4-客户端接收数据"><span class="nav-number">3.4.</span> <span class="nav-text">0x2.4 客户端接收数据</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x3-WMI调试1——检索信息"><span class="nav-number">4.</span> <span class="nav-text">0x3 WMI调试1——检索信息</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x3-1-WMI连接"><span class="nav-number">4.1.</span> <span class="nav-text">0x3.1 WMI连接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x3-2-WMI查询"><span class="nav-number">4.2.</span> <span class="nav-text">0x3.2 WMI查询</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x3-3-Get方法获取属性值"><span class="nav-number">4.3.</span> <span class="nav-text">0x3.3 Get方法获取属性值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x3-4-GetNames方法获取属性值"><span class="nav-number">4.4.</span> <span class="nav-text">0x3.4 GetNames方法获取属性值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x3-5-总结获取进程信息原理"><span class="nav-number">4.5.</span> <span class="nav-text">0x3.5 总结获取进程信息原理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x4-WMI调试2——执行函数"><span class="nav-number">5.</span> <span class="nav-text">0x4 WMI调试2——执行函数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x4-1-初始分析"><span class="nav-number">5.1.</span> <span class="nav-text">0x4.1 初始分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x4-2-调用ExecMethod方法"><span class="nav-number">5.2.</span> <span class="nav-text">0x4.2 调用ExecMethod方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x4-3-填充类实例"><span class="nav-number">5.3.</span> <span class="nav-text">0x4.3 填充类实例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x4-4-总结"><span class="nav-number">5.4.</span> <span class="nav-text">0x4.4 总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x5-参考文献"><span class="nav-number">6.</span> <span class="nav-text">0x5 参考文献</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HaCky</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  
  

  

  

  

</body>
</html>
