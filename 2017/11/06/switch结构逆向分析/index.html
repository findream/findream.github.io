<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="findream's blog" type="application/atom+xml" />






<meta name="description" content="&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;暑假看了看雪的知识库，偶然间看到这篇besterChen写的switch结构分析一文，甚喜之，原封不动的抄了下来，在此表示非常感谢。这是在暑假的word版经过复核及重新测试，发现原文许多反汇编代码与原先语句有出入，可能是现在编译器更加高级了。为了保证原文的统一和完整性，在此没有对原文代码进行修改，只是在后面进行了补充，形式为图">
<meta property="og:type" content="article">
<meta property="og:title" content="switch结构逆向分析">
<meta property="og:url" content="http://yoursite.com/2017/11/06/switch结构逆向分析/index.html">
<meta property="og:site_name" content="findream&#39;s blog">
<meta property="og:description" content="&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;暑假看了看雪的知识库，偶然间看到这篇besterChen写的switch结构分析一文，甚喜之，原封不动的抄了下来，在此表示非常感谢。这是在暑假的word版经过复核及重新测试，发现原文许多反汇编代码与原先语句有出入，可能是现在编译器更加高级了。为了保证原文的统一和完整性，在此没有对原文代码进行修改，只是在后面进行了补充，形式为图">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-11-07T03:01:48.228Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="switch结构逆向分析">
<meta name="twitter:description" content="&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;暑假看了看雪的知识库，偶然间看到这篇besterChen写的switch结构分析一文，甚喜之，原封不动的抄了下来，在此表示非常感谢。这是在暑假的word版经过复核及重新测试，发现原文许多反汇编代码与原先语句有出入，可能是现在编译器更加高级了。为了保证原文的统一和完整性，在此没有对原文代码进行修改，只是在后面进行了补充，形式为图">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/11/06/switch结构逆向分析/"/>





  <title>switch结构逆向分析 | findream's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">findream's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-calendar"></i> <br />
            
            日程表
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/06/switch结构逆向分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="findream">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="findream's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">switch结构逆向分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-06T17:02:11+08:00">
                2017-11-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/安全/" itemprop="url" rel="index">
                    <span itemprop="name">安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>暑假看了看雪的知识库，偶然间看到这篇besterChen写的switch结构分析一文，甚喜之，原封不动的抄了下来，在此表示非常感谢。这是在暑假的word版经过复核及重新测试，发现原文许多反汇编代码与原先语句有出入，可能是现在编译器更加高级了。为了保证原文的统一和完整性，在此没有对原文代码进行修改，只是在后面进行了补充，形式为图片类型。随后也会附上关于本次的测试样本，在此立下个flag。以免遗忘。</strong><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>switch 结构的逆向难度在于不同分支的switch通过反编译器可能演变成不同的汇编语言版本，这就要求逆向工程师精确掌握反汇编switch的规律。灵活的运用调试器进行调试。</strong><br><a id="more"></a></p>
<h1 id="1-case-lt-3的情况："><a href="#1-case-lt-3的情况：" class="headerlink" title="1.case&lt;=3的情况："></a>1.case&lt;=3的情况：</h1><p>先看第一个程序段：</p>
<pre><code>
    switch (nscore)
    {
    case 1:
        ntmpNum = 1;
        break;
    case 3:
        ntmpNum = 3;
        break;
    case 4:
        ntmpNum = 4;
        break;
    default:
        ntmpNum = 10;
    }
    printf("%d", ntmpNum); // 要调用一下ntmpNum，否则上面的switch会被优化掉
</code></pre>
OD载入，看一下：
<pre><code>
    00401013 >|.  E8 0F010000    call    00401127     ;scanf
    00401018  |.  8B4424 08      mov     eax, dword ptr [esp+8]
    0040101C  |?  83C4 08        add     esp, 8          ; 上面scanf是C类调用
    0040101F  |?  48             dec     eax       ; 通过EAX的减法来判断属于哪个分支
    00401020  |?  74 1D          je      short 0040103F
    00401022  |.  83E8 02        sub     eax, 2
    00401025  \.  74 11          je      short 00401038
    00401027      48             dec     eax
    00401028      74 07          je      short 00401031
    0040102A      B8 0A000000    mov     eax, 0A
    0040102F      EB 13          jmp     short 00401044   ;break
    00401031  |.  B8 04000000    mov     eax, 4
    00401036  |.  EB 0C          jmp     short 00401044
    00401038  |?  B8 03000000    mov     eax, 3
    0040103D  |?  EB 05         jmp     short 00401044
    0040103F  |?  B8 01000000    mov     eax, 1
    00401044  |.  50             push    eax
    00401045  |?  68 38904000    push    00409038       ;  ASCII "%d"
</code></pre>
通过上述反汇编代码，我们容易得知：在有规律的switch语句中，汇编代码显得有规律，和if语句一致。测试结果与原文一致。
# 2.case项多于3项且有规律的情况：
第一个程序段：
<pre><code>
    scanf("%d", &nscore);
    switch (nscore)
    {
        case 3:
            ntmpNum = 1;
               break;
        case 1:
            ntmpNum = 3;
            break;
        case 5:
            ntmpNum = 4;
            break;
        case 9:
            ntmpNum = 4;
            break;
        case 7:
            ntmpNum = 4;
            break;
        case 11:
            ntmpNum = 4;
            break;
        default:
            ntmpNum = 10;
    }
    printf("%d", ntmpNum); // 要调用一下ntmpNum，否则上面的switch会被优化掉
</code></pre>
这段代码，我们将有规律的case打乱顺序，然后看编译器是怎么处理的。
OD中查看反汇编形式：
<pre><code>
    0040100E  |.  68 38904000   push    00409038            ; ASCII "%d"
    00401013  |.  E8 3F010000   call    00401157            ; scanf
    00401018  |.  8B4C24 08     mov     ecx, dword ptr [esp+8]  ;得到输入的内容
    0040101C  |.  83C4 08       add     esp, 8
    0040101F  |.  8D41 FF       lea     eax, dword ptr [ecx-1]  ;输入的内容-1; Switch (cases 1..B)
    00401022  |.  83F8 0A       cmp     eax, 0A
    00401025  |.  77 1C         ja      short 00401043
    00401027  |.  FF2485 641040>jmp     dword ptr [eax*4+401064] ;查表，跳转到对应的CASE中
    0040102E  |>  B8 01000000   mov     eax, 1             ;  Case 3 of switch 0040101F
    00401033  |.  EB 13         jmp     short 00401048
    00401035  |>  B8 03000000   mov     eax, 3             ;  Case 1 of switch 0040101F
    0040103A  |.  EB 0C         jmp     short 00401048
    0040103C  |>  B8 04000000   mov     eax, 4             ;  Cases 5,7,9,B of switch 0040101F
    00401041  |.  EB 05         jmp     short 00401048
    00401043  |>  B8 0A000000   mov     eax, 0A            ;  Default case of switch 0040101F
    00401048  |>  50            push    eax
    00401049  |.  68 38904000   push    00409038           ;  ASCII "%d"
    0040104E  |.  E8 D3000000   call    00401126           ;  printf
</code></pre>
跟随下这个表，我们发现，这个表就在调用它的函数后，如下：
<pre><code>
    00401064  00401035  switch.00401035
    00401068  00401043  switch.00401043          插入的是default分支的首地址
    0040106C  0040102E  switch.0040102E
    00401070  00401043  switch.00401043          插入的是default分支的首地址
    00401074  0040103C  switch.0040103C
    00401078  00401043  switch.00401043          插入的是default分支的首地址
    0040107C  0040103C  switch.0040103C
    00401080  00401043  switch.00401043          插入的是default分支的首地址
    00401084  0040103C  switch.0040103C
    00401088  00401043  switch.00401043          插入的是default分支的首地址
    0040108C  0040103C  switch.0040103C
</code></pre>
<font color="#DC143C">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;认真对比一下这个表，发现，它先是对case后的常量排序，然后再将对应的处理代码的首地址写成一个表，通过jmp   dword ptr [eax*4+401064] 查表直接进入到对应的case中。
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于缺省的case（我们是间隔2递增的case）在表中填充的是default分支的首地址。</font>
# 3.多于三项部分有规律的情况:
**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上个我们发现，它会给缺省的case表项中填补default分支的首地址，那我们将这个间隔调大，观察一下编译器会怎么处理，代码段如下：**
<pre><code>
    scanf("%d", &nscore); 
    switch (nscore)
    {
        case 1:
            ntmpNum = 1;
            break;
        case 2:
            ntmpNum = 2;
            break;
        case 3:
            ntmpNum = 3;
            break;
    //这里丢失20多个case
        case 26:
            ntmpNum = 26;
            break;
        case 27:
            ntmpNum = 27;
            break;
        case 28:
            ntmpNum = 28;
            break;
        default:
            ntmpNum = 10;
    }
    printf("%d", ntmpNum); // 要调用一下ntmpNum，否则上面的switch会被优化掉
</code></pre>
反汇编观察一下：
<pre><code>
    0040100E    68 38904000     push    00409038                      ; ASCII "%d"
    00401013    E8 6F010000     call    00401187                      ; scanf
    00401018    8B4C24 08       mov     ecx, dword ptr [esp+8]        ; 得到输入的内容
    0040101C    83C4 08         add     esp, 8
    0040101F    8D41 FF         lea     eax, dword ptr [ecx-1]        ; 输入的内容-1
    00401022    83F8 1B         cmp     eax, 1B
    00401025    77 39           ja      short 00401060
    00401027    33D2            xor     edx, edx
    00401029    8A90 9C104000   mov     dl, byte ptr [eax+40109C]     ; 检索case的下标索引值表
    ;它参与运算从地址表中找到对应的case地址
    0040102F    FF2495 80104000 jmp     dword ptr [edx*4+401080]  
    ; 通过值表填充的CASE索引值，查地址表
    00401036    B8 01000000     mov     eax, 1
    0040103B    EB 28           jmp     short 00401065                  ; break
    0040103D    B8 02000000     mov     eax, 2
    00401042    EB 21           jmp     short 00401065
    00401044    B8 03000000     mov     eax, 3
    00401049    EB 1A           jmp     short 00401065
    0040104B    B8 1A000000     mov     eax, 1A
    00401050    EB 13           jmp     short 00401065
    00401052    B8 1B000000     mov     eax, 1B
    00401057    EB 0C           jmp     short 00401065
    00401059    B8 1C000000     mov     eax, 1C
    0040105E    EB 05           jmp     short 00401065
    00401060    B8 0A000000     mov     eax, 0A
    00401065    50              push    eax
    00401066    68 38904000     push    00409038                         ; ASCII "%d"
</code></pre>
下标索引表：
<pre><code>
    0040109C    00          DB 00    case 1的索引值
    0040109D    01          DB 01    case 2的索引值
    0040109E    02          DB 02    case 3的索引值
    0040109F    06          DB 06    下面全部填充default的索引值
    004010A0    06          DB 06
    ...
    004010B4    06          DB 06
    004010B5    03          DB 03    case 4的索引值
    004010B6    04          DB 04    case 5的索引值
    004010B7    05          DB 05    case 6的索引值
</code></pre>
这样查两个表，缺省的case项在索引表中插入 default 的索引值，这样每个case项就节省了3个字节的空间。
<pre><code>
    mov     dl, byte ptr [eax+40109C]   // 40109C是索引表首地址
    jmp     dword ptr [edx*4+401080]    // 401080是跳转地址表的首地址。
</code></pre>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/11/05/浅谈数据结构之二叉树/" rel="next" title="浅谈数据结构之二叉树">
                <i class="fa fa-chevron-left"></i> 浅谈数据结构之二叉树
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/11/09/浅谈数据结构之队列/" rel="prev" title="数据结构之队列基础">
                数据结构之队列基础 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">findream</p>
              <p class="site-description motion-element" itemprop="description">Apes--change the world's animals</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-case-lt-3的情况："><span class="nav-number">1.</span> <span class="nav-text">1.case<=3的情况：</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">findream</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  
  

  

  

  

</body>
</html>
